<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset 2026 Challenge Tracker</title>
    <style>
        /* Reset 2026 - CrossFit Prosperity Custom Styles */
/* Brand Colors: #9BFB02 (Lime), #000000 (Black), #3146E7 (Electric Blue) */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #3146E7 0%, #000000 100%);
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

.header {
    background: white;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative;
}

.header-logo {
    max-width: 200px;
    height: auto;
    margin-bottom: 15px;
}

h1 {
    color: #9BFB02;
    font-size: 2.5em;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.subtitle {
    color: #3146E7;
    font-size: 1.2em;
    font-weight: 600;
}

.card {
    background: white;
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

h2 {
    color: #3146E7;
    margin-bottom: 20px;
    font-size: 1.8em;
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    color: #333;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 1.1em;
}

input[type="text"],
input[type="email"],
input[type="password"],
input[type="number"] {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1em;
    transition: border-color 0.3s;
}

input[type="text"]:focus,
input[type="email"]:focus,
input[type="password"]:focus,
input[type="number"]:focus {
    outline: none;
    border-color: #9BFB02;
}

.challenge-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}

.challenge-header {
    margin-bottom: 12px;
}

.challenge-name {
    font-weight: 600;
    color: #333;
    display: block;
    margin-bottom: 5px;
}

.challenge-points {
    color: #9BFB02;
    font-weight: 700;
    font-size: 0.9em;
}

.days-grid {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.day-checkbox {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.day-checkbox label {
    font-size: 0.85em;
    font-weight: 600;
    color: #666;
    margin: 0;
}

.day-checkbox input[type="checkbox"] {
    width: 24px;
    height: 24px;
    cursor: pointer;
    accent-color: #9BFB02;
}

.single-checkbox {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.single-checkbox input[type="checkbox"] {
    width: 24px;
    height: 24px;
    cursor: pointer;
    accent-color: #9BFB02;
}

.single-checkbox.deduction input[type="checkbox"] {
    accent-color: #ff6b6b;
}

.single-checkbox label {
    margin: 0;
    cursor: pointer;
    font-weight: 500;
}

.deduction-item {
    background: #fff3f3;
    border-left: 4px solid #ff6b6b;
}

.deduction-points {
    color: #ff6b6b;
}

.btn {
    background: linear-gradient(135deg, #9BFB02 0%, #7dd102 100%);
    color: #000;
    border: none;
    padding: 15px 40px;
    border-radius: 10px;
    font-size: 1.1em;
    font-weight: 700;
    cursor: pointer;
    width: 100%;
    transition: transform 0.2s, box-shadow 0.2s;
    margin-top: 10px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(155, 251, 2, 0.5);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary {
    background: linear-gradient(135deg, #3146E7 0%, #2236c7 100%);
    color: white;
}

.btn-secondary:hover {
    box-shadow: 0 5px 20px rgba(49, 70, 231, 0.5);
}

.btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    color: white;
}

.total-score {
    background: linear-gradient(135deg, #9BFB02 0%, #7dd102 100%);
    color: #000;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    margin-top: 20px;
    font-size: 1.5em;
    font-weight: 700;
}

.leaderboard-table {
    width: 100%;
    border-collapse: collapse;
}

.leaderboard-table th {
    background: linear-gradient(135deg, #3146E7 0%, #2236c7 100%);
    color: white;
    padding: 15px;
    text-align: left;
    font-weight: 600;
}

.leaderboard-table td {
    padding: 15px;
    border-bottom: 1px solid #e0e0e0;
}

.leaderboard-table tr:hover {
    background: #f8f9fa;
}

.rank {
    font-weight: 700;
    font-size: 1.2em;
    color: #3146E7;
}

.rank-1 { color: #FFD700; }
.rank-2 { color: #C0C0C0; }
.rank-3 { color: #CD7F32; }

.section {
    display: none;
}

.section.active {
    display: block;
}

.nav-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.nav-btn {
    flex: 1;
    min-width: 120px;
    padding: 12px;
    background: white;
    border: 2px solid #9BFB02;
    color: #000;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s;
}

.nav-btn.active {
    background: #9BFB02;
    color: #000;
}

.nav-btn.admin {
    border-color: #ff6b6b;
    color: #ff6b6b;
}

.nav-btn.admin.active {
    background: #ff6b6b;
    color: white;
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: none;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: none;
}

.info-message {
    background: #d1ecf1;
    color: #0c5460;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.login-container {
    max-width: 450px;
    margin: 50px auto;
}

.auth-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.auth-tab {
    flex: 1;
    padding: 12px;
    background: white;
    border: 2px solid #9BFB02;
    color: #000;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s;
    text-align: center;
}

.auth-tab.active {
    background: #9BFB02;
    color: #000;
}

.auth-form {
    display: none;
}

.auth-form.active {
    display: block;
}

.logged-in-user {
    background: linear-gradient(135deg, #9BFB02 0%, #7dd102 100%);
    color: #000;
    padding: 15px 20px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
    font-weight: 600;
}

.logout-btn {
    background: white;
    color: #000;
    border: 2px solid #000;
    padding: 8px 20px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
}

.forgot-password {
    text-align: center;
    margin-top: 15px;
}

.forgot-password a {
    color: #3146E7;
    text-decoration: none;
    font-weight: 600;
}

.forgot-password a:hover {
    text-decoration: underline;
}

.admin-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.admin-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}

.admin-card h3 {
    color: #3146E7;
    margin-bottom: 10px;
    font-size: 1.2em;
}

.admin-card .stat {
    font-size: 2em;
    font-weight: 700;
    color: #9BFB02;
}

.export-section {
    margin-top: 30px;
}

#app {
    display: none;
}

#app.active {
    display: block;
}

#authPage {
    display: block;
}

#authPage.hidden {
    display: none;
}

.loading {
    text-align: center;
    padding: 50px;
    color: white;
    font-size: 1.2em;
}

.user-list {
    max-height: 400px;
    overflow-y: auto;
}

.user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 10px;
}

.user-info {
    flex: 1;
}

.user-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}

.small-btn {
    padding: 6px 12px;
    font-size: 0.9em;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 600;
}

.btn-hide {
    background: #ffc107;
    color: #000;
}

.btn-show {
    background: #28a745;
    color: white;
}

.team-select {
    padding: 6px 10px;
    border-radius: 6px;
    border: 2px solid #e0e0e0;
    font-weight: 600;
    cursor: pointer;
}

.team-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 700;
    color: white;
    margin-left: 8px;
}

.team-red { background: #ff6b6b; }
.team-blue { background: #3146E7; }
.team-green { background: #9BFB02; color: #000; }
.team-yellow { background: #ffd93d; color: #333; }
.team-purple { background: #a55eea; }
.team-orange { background: #ff9f43; }
.team-pink { background: #fd79a8; }
.team-teal { background: #00d2d3; }

.team-leaderboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.team-card {
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    color: white;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.team-card h3 {
    margin-bottom: 10px;
    font-size: 1.3em;
}

.team-card .team-stat {
    font-size: 2em;
    font-weight: 700;
}

.team-card .team-members {
    font-size: 0.9em;
    opacity: 0.9;
    margin-top: 5px;
}

.captain-badge {
    display: inline-block;
    padding: 3px 10px;
    background: gold;
    color: #333;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 700;
    margin-left: 8px;
}

.team-detail-section {
    margin-bottom: 40px;
}

.team-header {
    padding: 20px;
    padding-right: 60px;
    border-radius: 15px;
    color: white;
    margin-bottom: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.team-header:hover {
    opacity: 0.9;
    transform: translateY(-2px);
}

.team-header::after {
    content: '‚ñº';
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2em;
    transition: transform 0.3s;
}

.team-header.collapsed::after {
    transform: translateY(-50%) rotate(-90deg);
}

.team-members-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out, opacity 0.3s, padding 0.3s;
    opacity: 0;
    padding-top: 0;
}

.team-members-container.expanded {
    max-height: 2000px;
    opacity: 1;
    padding-top: 20px;
}

.team-name-input {
    background: rgba(255, 255, 255, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.5);
    color: white;
    padding: 12px 22px 12px 15px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1em;
    margin-left: 10px;
    margin-right: 10px;
    width: 200px;
}

.team-name-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.team-color-label {
    font-size: 0.8em;
    opacity: 0.8;
    display: block;
    margin-bottom: 5px;
}

.team-header h3 {
    font-size: 2em;
    margin: 0;
}

.team-total {
    text-align: right;
}

.team-total .label {
    font-size: 0.9em;
    opacity: 0.9;
}

.team-total .points {
    font-size: 2em;
    font-weight: 700;
}

.team-members-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}

.member-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid;
}

.member-card.current-user {
    background: #e8f5e9;
    border-left-width: 6px;
}

.member-name {
    font-weight: 700;
    font-size: 1.1em;
    margin-bottom: 5px;
}

.member-points {
    font-size: 1.5em;
    font-weight: 700;
    color: #3146E7;
}

.no-team-section {
    background: #fff3cd;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid #ffc107;
    margin-bottom: 20px;
}

.checkin-closed-banner {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
    font-size: 1.1em;
    font-weight: 600;
}

.checkin-closed-banner strong {
    display: block;
    font-size: 1.3em;
    margin-bottom: 10px;
}

.checkin-open-banner {
    background: linear-gradient(135deg, #9BFB02 0%, #7dd102 100%);
    color: #000;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: 700;
}

.window-control {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.window-status {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 700;
    margin-left: 10px;
}

.window-status.open {
    background: #d4edda;
    color: #155724;
}

.window-status.closed {
    background: #f8d7da;
    color: #721c24;
}

/* Locker Room Styles */
.locker-room-challenge {
    background: linear-gradient(135deg, #3146E7 0%, #2236c7 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
}

.locker-room-challenge h3 {
    font-size: 1.8em;
    margin-bottom: 15px;
}

.challenge-text {
    font-size: 1.2em;
    line-height: 1.6;
    margin-bottom: 15px;
}

.edit-challenge-btn {
    background: white;
    color: #3146E7;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
}

.challenge-edit-area {
    width: 100%;
    padding: 15px;
    border-radius: 10px;
    border: 2px solid white;
    font-size: 1.1em;
    margin: 15px 0;
    min-height: 100px;
}

.messages-container {
    max-height: 600px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.message-item {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    border-left: 4px solid #3146E7;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
    gap: 10px;
}

.message-author {
    font-weight: 700;
    font-size: 1.1em;
    color: #333;
}

.message-timestamp {
    color: #999;
    font-size: 0.9em;
}

.message-text {
    color: #333;
    font-size: 1.05em;
    line-height: 1.5;
}

.delete-message-btn {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 5px 12px;
    border-radius: 5px;
    font-size: 0.85em;
    cursor: pointer;
    margin-left: 10px;
}

.message-input-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
}

.message-input-container textarea {
    width: 100%;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1em;
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
}

.message-input-container textarea:focus {
    outline: none;
    border-color: #9BFB02;
}

.char-counter {
    text-align: right;
    color: #999;
    font-size: 0.9em;
    margin-top: 5px;
}

.char-counter.warning {
    color: #ff6b6b;
}

/* Profile Styles */
.profile-photo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #9BFB02;
    margin-right: 10px;
}

.profile-photo.large {
    width: 120px;
    height: 120px;
    border: 4px solid #9BFB02;
}

.profile-photo.small {
    width: 30px;
    height: 30px;
    border: 2px solid #e0e0e0;
}

.profile-container {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
}

.profile-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmin(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.profile-info-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
}

.profile-info-item label {
    display: block;
    font-weight: 600;
    color: #666;
    font-size: 0.9em;
    margin-bottom: 8px;
}

.profile-info-item .value {
    font-size: 1.1em;
    color: #333;
    font-weight: 500;
}

.profile-edit-input {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1em;
}

.photo-upload-btn {
    background: #9BFB02;
    color: #000;
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 700;
}

.photo-upload-btn:hover {
    background: #7dd102;
}

.clickable-name {
    cursor: pointer;
    color: #3146E7;
    text-decoration: none;
}

.clickable-name:hover {
    text-decoration: underline;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    overflow: auto;
}

.modal.active {
    display: flex !important;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-close {
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #999;
}

.modal-close:hover {
    color: #333;
}

/* Challenge Editor Modal */
.challenge-editor-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.challenge-editor-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.challenge-editor-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    max-width: 700px;
    width: 90%;
}

.challenge-editor-textarea {
    width: 100%;
    min-height: 200px;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1.1em;
    font-family: inherit;
    line-height: 1.6;
    resize: vertical;
}

.challenge-editor-textarea:focus {
    outline: none;
    border-color: #9BFB02;
}

.editor-toolbar {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.editor-btn {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: #333;
    transition: background 0.2s;
}

.editor-btn:hover {
    background: #e9ecef;
}

.editor-preview {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-top: 15px;
    min-height: 100px;
    border: 2px dashed #e0e0e0;
}

.editor-preview h3 {
    margin-bottom: 10px;
    color: #666;
}

.editor-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* Point Adjustment Styles */
.point-adjustment-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.adjustment-form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.adjustment-input {
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1em;
}

.adjustment-history {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 20px;
}

.adjustment-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid #3146E7;
}

.adjustment-item.positive {
    border-left-color: #9BFB02;
}

.adjustment-item.negative {
    border-left-color: #ff6b6b;
}

/* Promote Admin Button */
.promote-admin-btn {
    background: linear-gradient(135deg, #ffd93d 0%, #f5c542 100%);
    color: #333;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: 700;
    cursor: pointer;
}

.admin-badge {
    background: gold;
    color: #333;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 700;
    margin-left: 8px;
}

/* Clickable profile elements */
.profile-clickable {
    cursor: pointer;
    transition: opacity 0.2s;
}

.profile-clickable:hover {
    opacity: 0.8;
}

/* Team Colors CSS Variables */
:root {
    --team-red: #ff6b6b;
    --team-blue: #3146E7;
    --team-green: #9BFB02;
    --team-yellow: #ffd93d;
    --team-purple: #a55eea;
    --team-orange: #ff9f43;
    --team-pink: #fd79a8;
    --team-teal: #00d2d3;
}

/* Responsive Design */
@media (max-width: 600px) {
    h1 {
        font-size: 1.8em;
    }
    
    .header-logo {
        max-width: 150px;
    }
    
    .challenge-item {
        gap: 15px;
    }
    
    .days-grid {
        width: 100%;
        justify-content: space-between;
    }

    .day-checkbox {
        flex: 1;
        min-width: 40px;
    }

    .nav-buttons {
        flex-direction: column;
    }

    .nav-btn {
        width: 100%;
    }
    /* Fix leaderboard table on mobile */
    .leaderboard-table {
        font-size: 0.85em;
    }
    
    .leaderboard-table th,
    .leaderboard-table td {
        padding: 10px 5px;
    }
    
    .profile-photo.small {
        width: 25px;
        height: 25px;
    }
    
    .team-badge {
        font-size: 0.7em;
        padding: 3px 8px;
    }
    
    .rank {
        font-size: 1em;
    }
    
    /* Make team leaderboard single column on mobile */
    .team-leaderboard {
        grid-template-columns: 1fr;
    }
}
        </style>
</head>
<body>
    <div class="loading" id="loading">Loading Reset 2026...</div>

    <!-- Authentication Page -->
    <div id="authPage" style="display: none;">
        <div class="login-container">
            <div class="header">
                <h1>RESET 2026</h1>
                <p class="subtitle">Nutrition & Fitness Challenge</p>
            </div>

            <div class="card">
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="showAuthTab('login')">Login</div>
                    <div class="auth-tab" onclick="showAuthTab('register')">Register</div>
                </div>

                <div class="error-message" id="authError"></div>
                <div class="success-message" id="authSuccess"></div>

                <!-- Login Form -->
                <form id="loginForm" class="auth-form active">
                    <h2>Welcome Back!</h2>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn" id="loginBtn">Login</button>
                    <div class="forgot-password">
                        <a href="#" onclick="showAuthTab('reset'); return false;">Forgot Password?</a>
                    </div>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="auth-form">
                    <h2>Join the Challenge</h2>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="regName" required>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="regPassword" required minlength="6">
                    </div>
                    <button type="submit" class="btn" id="registerBtn">Create Account</button>
                </form>

                <!-- Password Reset Form -->
                <form id="resetForm" class="auth-form">
                    <h2>Reset Password</h2>
                    <p style="color: #666; margin-bottom: 20px;">Enter your email address and we'll send you a link to reset your password.</p>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="resetEmail" required>
                    </div>
                    <button type="submit" class="btn" id="resetBtn">Send Reset Link</button>
                    <div class="forgot-password">
                        <a href="#" onclick="showAuthTab('login'); return false;">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="app" class="container" style="display: none;">
        <div class="header">
            <h1>RESET 2026</h1>
            <p class="subtitle">Nutrition & Fitness Challenge Tracker</p>
        </div>

        <div class="logged-in-user">
            <span id="userGreeting">Welcome!</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

    <div class="nav-buttons">
    <button class="nav-btn active" onclick="showSection('checkin')">Check In</button>
    <button class="nav-btn" onclick="showSection('profile')">My Profile</button>
    <button class="nav-btn" onclick="showSection('leaderboard')">The Whiteboard</button>
    <button class="nav-btn" onclick="showSection('teams')">Teams</button>
    <button class="nav-btn" onclick="showSection('locker')">The Locker Room</button>
    <button class="nav-btn admin" id="adminNavBtn" onclick="showSection('admin')" style="display: none;">Admin</button>
</div>

        <!-- Check In Section -->
        <div id="checkin" class="section active">
            <div class="card">
                <h2>Weekly Check-In</h2>
                
                <!-- Check-in window status banner -->
                <div id="checkinWindowBanner"></div>
                
                <div class="success-message" id="checkinSuccess"></div>
                <form id="checkinForm">
                    <h3 style="color: #7ed957; margin: 30px 0 15px 0;">üí™ Earn Points</h3>
                    
                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Hit Protein Goal</span>
                            <span class="challenge-points">+5 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_mon" class="protein-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_tue" class="protein-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_wed" class="protein-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_thu" class="protein-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_fri" class="protein-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_sat" class="protein-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_sun" class="protein-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Hit Water Goal</span>
                            <span class="challenge-points">+5 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_mon" class="water-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_tue" class="water-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_wed" class="water-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_thu" class="water-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_fri" class="water-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_sat" class="water-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_sun" class="water-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Attended 3+ Classes This Week</span>
                            <span class="challenge-points">+15 pts</span>
                        </div>
                        <div class="single-checkbox">
                            <input type="checkbox" id="classes">
                            <label for="classes">Completed</label>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Stretching/Yoga/Recovery</span>
                            <span class="challenge-points">+3 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_mon" class="recovery-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_tue" class="recovery-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_wed" class="recovery-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_thu" class="recovery-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_fri" class="recovery-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_sat" class="recovery-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_sun" class="recovery-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Completed Weekly Challenge</span>
                            <span class="challenge-points">+20 pts</span>
                        </div>
                        <div class="single-checkbox">
                            <input type="checkbox" id="weekly">
                            <label for="weekly">Completed</label>
                        </div>
                    </div>

                    <h3 style="color: #ff6b6b; margin: 30px 0 15px 0;">‚ö†Ô∏è Deductions</h3>

                    <div class="challenge-item deduction-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Consumed Alcohol</span>
                            <span class="challenge-points deduction-points">-5 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_mon" class="alcohol-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_tue" class="alcohol-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_wed" class="alcohol-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_thu" class="alcohol-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_fri" class="alcohol-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_sat" class="alcohol-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_sun" class="alcohol-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item deduction-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Late to Class</span>
                            <span class="challenge-points deduction-points">-3 pts/occurrence</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_mon" class="late-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_tue" class="late-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_wed" class="late-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_thu" class="late-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_fri" class="late-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_sat" class="late-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_sun" class="late-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item deduction-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Missed Weekly Check-In</span>
                            <span class="challenge-points deduction-points">-10 pts</span>
                        </div>
                        <div class="single-checkbox deduction">
                            <input type="checkbox" id="missed">
                            <label for="missed">Yes, I missed last week</label>
                        </div>
                    </div>

                    <div class="total-score" id="totalScore">
                        Total Weekly Score: 0 points
                    </div>

                    <button type="submit" class="btn" id="checkinBtn">Submit Check-In</button>
                </form>
            </div>
        </div>
<!-- My Profile Section -->
        <div id="profile" class="section">
            <div class="card">
                <h2>üë§ My Profile</h2>
                
                <div class="profile-container">
                    <img id="profilePhotoDisplay" class="profile-photo large" 
                         src="https://ui-avatars.com/api/?name=User&background=4facfe&color=fff&size=120" 
                         alt="Profile Photo">
                    <div>
                        <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="uploadProfilePhoto()">
                        <button class="photo-upload-btn" onclick="document.getElementById('photoUpload').click()">
                            üì∑ Upload Photo
                        </button>
                        <p style="color: #666; font-size: 0.9em; margin-top: 10px;">Max 5MB ‚Ä¢ JPG, PNG, or GIF</p>
                    </div>
                </div>

                <div class="profile-info-grid">
                    <div class="profile-info-item">
                        <label>Nickname</label>
                        <input type="text" class="profile-edit-input" id="profileNickname" 
                               placeholder="Your nickname" maxlength="30">
                    </div>
                    <div class="profile-info-item">
                        <label>Favorite CrossFit Movement</label>
                        <input type="text" class="profile-edit-input" id="profileMovement" 
                               placeholder="e.g., Deadlift, Box Jumps" maxlength="50">
                    </div>
                    <div class="profile-info-item">
                        <label>Favorite Veggie</label>
                        <input type="text" class="profile-edit-input" id="profileVeggie" 
                               placeholder="e.g., Broccoli, Carrots" maxlength="50">
                    </div>
                    <div class="profile-info-item">
                        <label>#1 Goal This Challenge</label>
                        <input type="text" class="profile-edit-input" id="profileGoal" 
                               placeholder="e.g., Lose 10lbs, PR my deadlift" maxlength="100">
                    </div>
                </div>

                <button class="btn" onclick="saveProfile()" style="margin-top: 30px;">
                    üíæ Save Profile
                </button>
            </div>
        </div>

        <!-- Challenge Editor Modal -->
    <div id="challengeEditorModal" class="challenge-editor-modal">
        <div class="challenge-editor-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">‚úèÔ∏è Edit Weekly Challenge</h2>
                <span class="modal-close" onclick="closeChallengeEditor()">&times;</span>
            </div>

            <div class="editor-toolbar">
                <button class="editor-btn" onclick="insertText('**', '**')" title="Bold">
                    <strong>B</strong>
                </button>
                <button class="editor-btn" onclick="insertText('*', '*')" title="Italic">
                    <em>I</em>
                </button>
                <button class="editor-btn" onclick="insertText('‚Ä¢ ', '')" title="Bullet Point">
                    ‚Ä¢ List
                </button>
                <button class="editor-btn" onclick="insertText('üí™ ', '')" title="Add Emoji">
                    üòä Emoji
                </button>
                <button class="editor-btn" onclick="insertText('\n---\n', '')" title="Divider">
                    ‚ûñ Line
                </button>
            </div>

            <textarea id="challengeEditorText" class="challenge-editor-textarea" 
                      placeholder="Enter this week's challenge...

Examples:
- Complete 15 burpees every day
- Drink 100oz of water daily
- No sugar Mon-Fri

**Bonus:** Post your PR in The Locker Room! üí™"></textarea>

            <div class="editor-preview">
                <h3>Preview:</h3>
                <div id="challengePreview"></div>
            </div>

            <div class="editor-actions">
                <button class="btn" onclick="saveChallengeFromEditor()">
                    üíæ Save Challenge
                </button>
                <button class="btn btn-secondary" onclick="closeChallengeEditor()" 
                        style="background: #999;">
                    Cancel
                </button>
            </div>
        </div>
    </div>
        <!-- Leaderboard Section -->
        <div id="leaderboard" class="section">
            <div class="card">
                <h2>üèÜ The Whiteboard</h2>
                
                <!-- Team Standings -->
                <div id="teamStandings" style="margin-bottom: 30px;">
                    <h3 style="color: #4facfe; margin-bottom: 15px;">Team Standings</h3>
                    <div class="team-leaderboard" id="teamLeaderboard">
                        <!-- Team cards will be inserted here -->
                    </div>
                </div>

                <h3 style="color: #4facfe; margin-bottom: 15px;">Individual Rankings</h3>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Team</th>
                            <th>Total Points</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr><td colspan="4" style="text-align: center; padding: 30px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Teams Page -->
        <div id="teams" class="section">
            <div class="card">
                <h2>üë• Team Rosters</h2>
                <p style="color: #666; margin-bottom: 30px;">View all team members, captains, and individual scores</p>
                <div id="teamsContent">
                    <p style="text-align: center; padding: 30px;">Loading teams...</p>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="admin" class="section">
            <div class="card">
                <h2>üîß Admin Dashboard</h2>
                <div class="info-message">
                    <strong>Admin Access:</strong> You can export data and manage user visibility on the leaderboard.
                </div>

                <div class="admin-controls">
                    <div class="admin-card">
                        <h3>Total Users</h3>
                        <div class="stat" id="totalUsers">0</div>
                    </div>
                    <div class="admin-card">
                        <h3>Total Check-ins</h3>
                        <div class="stat" id="totalCheckins">0</div>
                    </div>
                    <div class="admin-card">
                        <h3>Visible Users</h3>
                        <div class="stat" id="visibleUsers">0</div>
                    </div>
                </div>

                <div class="window-control">
                    <h3 style="margin-bottom: 15px;">‚è∞ Check-In Window Control</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        Control when members can submit their weekly check-ins. When closed, members will see a message and cannot check in.
                    </p>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <span style="font-weight: 600;">Current Status:</span>
                        <span class="window-status" id="windowStatus">Loading...</span>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="window.toggleCheckinWindow(true)" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);">
                            ‚úÖ Open Check-Ins
                        </button>
                        <button class="btn btn-danger" onclick="window.toggleCheckinWindow(false)" style="flex: 1; min-width: 150px;">
                            üö´ Close Check-Ins
                        </button>
                    </div>
                    <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                        üí° Tip: Close check-ins on Sunday night and reopen them Monday morning for the new week!
                    </p>
                </div>
                <div class="point-adjustment-section">
                    <h3 style="margin-bottom: 15px;">üîß Manual Point Adjustment</h3>
                    <p style="color: #666; margin-bottom: 15px;">Add or subtract points with a reason (e.g., forgot to log something, bonus achievement)</p>
                    
                    <div class="adjustment-form">
                        <select id="adjustmentUser" class="adjustment-input">
                            <option value="">Select User...</option>
                        </select>
                        <input type="number" id="adjustmentPoints" class="adjustment-input" 
                               placeholder="Points (+10 or -5)" step="1">
                        <input type="text" id="adjustmentReason" class="adjustment-input" 
                               placeholder="Reason (e.g., Forgot Monday protein)" 
                               style="grid-column: 1 / -1;">
                    </div>
                    
                    <button class="btn btn-secondary" onclick="applyPointAdjustment()">
                        ‚úÖ Apply Adjustment
                    </button>

                    <div class="adjustment-history" id="adjustmentHistory">
                        <h4 style="margin-bottom: 10px;">Recent Adjustments</h4>
                        <p style="color: #999; text-align: center; padding: 20px;">No adjustments yet</p>
                    </div>
                </div>

                <div class="export-section">
                    <h3>Export Data</h3>
                    <p style="margin-bottom: 15px; color: #666;">Download all user and check-in data as CSV files for analysis.</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportUsersCSV()" style="flex: 1; min-width: 200px;">
                            üìä Export All Users
                        </button>
                        <button class="btn btn-secondary" onclick="exportCheckinsCSV()" style="flex: 1; min-width: 200px;">
                            üìã Export All Check-ins
                        </button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Customize Team Names</h3>
                    <p style="margin-bottom: 15px; color: #666;">Give each team a custom name while keeping their colors!</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: #ff6b6b; padding: 15px; border-radius: 10px; color: white;">
                            <strong>üî¥ Red Team</strong>
                            <input type="text" class="team-name-input" id="teamName_red" placeholder="e.g., Red Warriors" 
                                   onblur="window.updateTeamName('red', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #4facfe; padding: 15px; border-radius: 10px; color: white;">
                            <strong>üîµ Blue Team</strong>
                            <input type="text" class="team-name-input" id="teamName_blue" placeholder="e.g., Blue Legends" 
                                   onblur="window.updateTeamName('blue', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #7ed957; padding: 15px; border-radius: 10px; color: white;">
                            <strong>üü¢ Green Team</strong>
                            <input type="text" class="team-name-input" id="teamName_green" placeholder="e.g., Green Machines" 
                                   onblur="window.updateTeamName('green', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #ffd93d; padding: 15px; border-radius: 10px; color: #333;">
                            <strong>üü° Yellow Team</strong>
                            <input type="text" class="team-name-input" id="teamName_yellow" placeholder="e.g., Yellow Thunder" 
                                   onblur="window.updateTeamName('yellow', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}" 
                                   style="color: #333; background: rgba(255,255,255,0.8);">
                        </div>
                        <div style="background: #a55eea; padding: 15px; border-radius: 10px; color: white;">
                            <strong>üü£ Purple Team</strong>
                            <input type="text" class="team-name-input" id="teamName_purple" placeholder="e.g., Purple Reign" 
                                   onblur="window.updateTeamName('purple', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #ff9f43; padding: 15px; border-radius: 10px; color: white;">
                            <strong>üü† Orange Team</strong>
                            <input type="text" class="team-name-input" id="teamName_orange" placeholder="e.g., Orange Crush" 
                                   onblur="window.updateTeamName('orange', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #fd79a8; padding: 15px; border-radius: 10px; color: white;">
                            <strong>ü©∑ Pink Team</strong>
                            <input type="text" class="team-name-input" id="teamName_pink" placeholder="e.g., Pink Panthers" 
                                   onblur="window.updateTeamName('pink', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #00d2d3; padding: 15px; border-radius: 10px; color: white;">
                            <strong>ü©µ Teal Team</strong>
                            <input type="text" class="team-name-input" id="teamName_teal" placeholder="e.g., Teal Titans" 
                                   onblur="window.updateTeamName('teal', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Manage User Teams & Visibility</h3>
                    <p style="margin-bottom: 15px; color: #666;">Assign users to colored teams and control leaderboard visibility.</p>
                    <div class="user-list" id="adminUserList">
                        <p style="text-align: center; padding: 20px;">Loading users...</p>
                    </div>
                </div>

                <div class="export-section" style="margin-top: 30px;">
                    <h3>Export by Team</h3>
                    <p style="margin-bottom: 15px; color: #666;">Download user and check-in data filtered by team.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button class="btn btn-secondary" onclick="exportTeamData('red')" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);">
                            üìä Red Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('blue')" style="background: linear-gradient(135deg, #4facfe 0%, #3d8fd1 100%);">
                            üìä Blue Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('green')" style="background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);">
                            üìä Green Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('yellow')" style="background: linear-gradient(135deg, #ffd93d 0%, #f5c542 100%);">
                            üìä Yellow Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('purple')" style="background: linear-gradient(135deg, #a55eea 0%, #8854d0 100%);">
                            üìä Purple Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('orange')" style="background: linear-gradient(135deg, #ff9f43 0%, #ee8f34 100%);">
                            üìä Orange Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('pink')" style="background: linear-gradient(135deg, #fd79a8 0%, #e66992 100%);">
                            üìä Pink Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('teal')" style="background: linear-gradient(135deg, #00d2d3 0%, #00b4b5 100%);">
                            üìä Teal Team
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- The Locker Room -->
        <div id="locker" class="section">
            <div class="card">
                <h2>üí¨ The Locker Room</h2>
                <p style="color: #666; margin-bottom: 20px;">Share PRs, wins, and talk with your teammates!</p>

                <!-- Weekly Challenge -->
                <div class="locker-room-challenge" id="weeklyChallenge">
                    <h3>üéØ This Week's Challenge</h3>
                    <div class="challenge-text" id="challengeText">
                        Loading challenge...
                    </div>
                    <button class="edit-challenge-btn" id="editChallengeBtn" style="display: none;" onclick="editChallenge()">
                        ‚úèÔ∏è Edit Challenge
                    </button>
                </div>

                <!-- Messages -->
                <h3 style="margin-bottom: 15px;">üì¢ Message Board</h3>
                <div class="messages-container" id="messagesContainer">
                    <p style="text-align: center; padding: 30px; color: #999;">Loading messages...</p>
                </div>

                <!-- Post Message -->
                <div class="message-input-container">
                    <textarea id="messageInput" placeholder="Share a PR, celebrate a win, or talk some friendly trash... üí™" maxlength="500"></textarea>
                    <div class="char-counter" id="charCounter">0 / 500</div>
                    <button class="btn" onclick="postMessage()" id="postMessageBtn" style="margin-top: 15px;">
                        üì§ Post Message
                    </button>
                </div>
            </div>
        </div>
            <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeProfileModal()">&times;</span>
            <div id="profileModalContent">
                <!-- Profile content loads here -->
            </div>
        </div>
    </div>
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, where, getDocs, updateDoc, increment, addDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        // REPLACE THESE WITH YOUR FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDbvV8uX5OnPRJChm6Q58ca7lyvHg2jqRo",
  authDomain: "reset-2026-tracker.firebaseapp.com",
  projectId: "reset-2026-tracker",
  storageBucket: "reset-2026-tracker.firebasestorage.app",
  messagingSenderId: "867262535384",
  appId: "1:867262535384:web:a9d18d62159c657f4ca9ad"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ADMIN EMAIL - Change this to YOUR email address
        const ADMIN_EMAILS = [
    "seanswetz@pm.me",  // ‚Üê Replace with YOUR actual email
    "another-admin@example.com"  // ‚Üê Add more admin emails here
];

        let currentUser = null;
        let isAdmin = false;

        // Hide loading screen
        document.getElementById('loading').style.display = 'none';

        // Check auth state
    onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
            currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
            
            // Load admin users from database
            await loadAdminUsers();  // ‚Üê THIS LINE MUST BE HERE
            
            isAdmin = ADMIN_EMAILS.includes(user.email.toLowerCase());
            showApp();
        }
    } else {
        showAuthPage();
    }
});

        function showApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('userGreeting').textContent = `Welcome, ${currentUser.name}!${isAdmin ? ' (Admin)' : ''}`;
            
            if (isAdmin) {
                document.getElementById('adminNavBtn').style.display = 'block';
            }
            
            checkCheckinWindow();
            loadLeaderboard();
        }

        function showAuthPage() {
            document.getElementById('authPage').style.display = 'block';
            document.getElementById('app').style.display = 'none';
        }

        // Auth tab switching
        window.showAuthTab = function(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else if (tab === 'register') {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            } else if (tab === 'reset') {
                document.getElementById('resetForm').classList.add('active');
            }
            hideMessages();
        };

        function hideMessages() {
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showAuthSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 5000);
        }

        // Registration
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const btn = document.getElementById('registerBtn');

            btn.disabled = true;
            btn.textContent = 'Creating Account...';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    totalPoints: 0,
                    team: 'none',
                    isCaptain: false,
                    hiddenFromLeaderboard: false,
                    registeredAt: new Date().toISOString()
                });

                showAuthSuccess('Account created successfully!');
                document.getElementById('registerForm').reset();
                setTimeout(() => window.showAuthTab('login'), 2000);
            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showAuthError('This email is already registered. Please login instead.');
                } else if (error.code === 'auth/weak-password') {
                    showAuthError('Password should be at least 6 characters.');
                } else {
                    showAuthError('Registration failed. Please try again.');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.textContent = 'Logging in...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    showAuthError('Invalid email or password.');
                } else {
                    showAuthError('Login failed. Please try again.');
                }
                btn.disabled = false;
                btn.textContent = 'Login';
            }
        });

        // Password Reset
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const email = document.getElementById('resetEmail').value;
            const btn = document.getElementById('resetBtn');

            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                await sendPasswordResetEmail(auth, email);
                showAuthSuccess('Password reset email sent! Check your inbox.');
                document.getElementById('resetForm').reset();
                setTimeout(() => window.showAuthTab('login'), 3000);
            } catch (error) {
                console.error('Reset error:', error);
                if (error.code === 'auth/user-not-found') {
                    showAuthError('No account found with this email.');
                } else {
                    showAuthError('Failed to send reset email. Please try again.');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Reset Link';
            }
        });

        // Logout
        window.logout = async function() {
            try {
                await signOut(auth);
                currentUser = null;
                isAdmin = false;
                document.getElementById('loginForm').reset();
                document.getElementById('adminNavBtn').style.display = 'none';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // Navigation
        window.showSection = function(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

           if (sectionName === 'leaderboard') {
            loadLeaderboard();
        } else if (sectionName === 'teams') {
            loadTeamsPage();
        } else if (sectionName === 'locker') {
            loadWeeklyChallenge();
            loadMessages();
        } else if (sectionName === 'profile') {
            loadUserProfile();
        } else if (sectionName === 'admin' && isAdmin) {
            loadAdminData();
        }
        };

        // Calculate total score
        function updateTotalScore() {
            const protein = document.querySelectorAll('.protein-check:checked').length;
            const water = document.querySelectorAll('.water-check:checked').length;
            const classes = document.getElementById('classes').checked ? 1 : 0;
            const recovery = document.querySelectorAll('.recovery-check:checked').length;
            const weekly = document.getElementById('weekly').checked ? 1 : 0;
            const alcohol = document.querySelectorAll('.alcohol-check:checked').length;
            const late = document.querySelectorAll('.late-check:checked').length;
            const missed = document.getElementById('missed').checked ? 1 : 0;

            const total = (protein * 5) + (water * 5) + (classes * 15) + 
                         (recovery * 3) + (weekly * 20) - (alcohol * 5) - 
                         (late * 3) - (missed * 10);

            document.getElementById('totalScore').textContent = 
                `Total Weekly Score: ${total} points`;
        }

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateTotalScore);
        });

        // Check-in Form
        document.getElementById('checkinForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) return;

            const btn = document.getElementById('checkinBtn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            const protein = document.querySelectorAll('.protein-check:checked').length;
            const water = document.querySelectorAll('.water-check:checked').length;
            const classes = document.getElementById('classes').checked ? 1 : 0;
            const recovery = document.querySelectorAll('.recovery-check:checked').length;
            const weekly = document.getElementById('weekly').checked ? 1 : 0;
            const alcohol = document.querySelectorAll('.alcohol-check:checked').length;
            const late = document.querySelectorAll('.late-check:checked').length;
            const missed = document.getElementById('missed').checked ? 1 : 0;

            const weeklyScore = (protein * 5) + (water * 5) + (classes * 15) + 
                               (recovery * 3) + (weekly * 20) - (alcohol * 5) - 
                               (late * 3) - (missed * 10);

            try {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    totalPoints: increment(weeklyScore),
                    lastCheckin: new Date().toISOString()
                });

                await addDoc(collection(db, 'checkins'), {
                    userId: currentUser.uid,
                    name: currentUser.name,
                    email: currentUser.email,
                    weeklyScore: weeklyScore,
                    details: { protein, water, classes, recovery, weekly, alcohol, late, missed },
                    timestamp: new Date().toISOString()
                });

                currentUser.totalPoints = (currentUser.totalPoints || 0) + weeklyScore;

                const successMsg = document.getElementById('checkinSuccess');
                successMsg.textContent = `Check-in submitted! You earned ${weeklyScore} points this week. Your total is now ${currentUser.totalPoints} points.`;
                successMsg.style.display = 'block';
                
                document.getElementById('checkinForm').reset();
                updateTotalScore();

                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 5000);

            } catch (error) {
                console.error('Check-in error:', error);
                alert('Failed to submit check-in. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit Check-In';
            }
        });

       // Load Leaderboard
        // Load Leaderboard
async function loadLeaderboard() {
    const tbody = document.getElementById('leaderboardBody');
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px;">Loading...</td></tr>';

    try {
        // Fetch all users (no complex query to avoid indexing issues)
        const q = query(collection(db, 'users'));
        const querySnapshot = await getDocs(q);
        
        const leaderboardData = [];
        const teamTotals = {
            red: { points: 0, members: 0 },
            blue: { points: 0, members: 0 },
            green: { points: 0, members: 0 },
            yellow: { points: 0, members: 0 },
            purple: { points: 0, members: 0 },
            orange: { points: 0, members: 0 },
            pink: { points: 0, members: 0 },
            teal: { points: 0, members: 0 }
        };

        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            // Only include users who aren't hidden from leaderboard
            if (!userData.hiddenFromLeaderboard) {
                leaderboardData.push({ uid: doc.id, ...userData });
                
                // Calculate team totals
                const team = userData.team || 'none';
                if (teamTotals[team]) {
                    teamTotals[team].points += (userData.totalPoints || 0);
                    teamTotals[team].members += 1;
                }
            }
        });

        // Sort by points (client-side)
        leaderboardData.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));

        // Display team standings
        displayTeamStandings(teamTotals);

        tbody.innerHTML = '';
        if (leaderboardData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">No check-ins yet. Be the first!</td></tr>';
            return;
        }

        leaderboardData.forEach((member, index) => {
            const row = tbody.insertRow();
            const rankClass = index < 3 ? `rank-${index + 1}` : '';
            const isCurrentUser = currentUser && member.uid === currentUser.uid;
            const teamBadge = member.team && member.team !== 'none' 
                ? `<span class="team-badge team-${member.team}">${member.team.toUpperCase()}</span>`
                : '';
            
            // Get photo URL or default avatar
            const photoURL = member.photoURL || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=4facfe&color=fff&size=40`;
            
            row.style.background = isCurrentUser ? '#e8f5e9' : '';
            row.style.cursor = 'pointer';
            row.classList.add('profile-clickable');
            
            // Add click handler to the row
            row.onclick = function() {
    console.log('Clicked user:', member.uid, member.name);
    viewUserProfile(member.uid);
};
            
            row.innerHTML = `
                <td><span class="rank ${rankClass}">${index + 1}</span></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="${photoURL}" class="profile-photo small" alt="${member.name}">
                        <span>${member.name}${isCurrentUser ? ' (You)' : ''}</span>
                    </div>
                </td>
                <td>${teamBadge || '<span style="color: #999;">No Team</span>'}</td>
                <td><strong>${member.totalPoints || 0} pts</strong></td>
            `;
        });

    } catch (error) {
        console.error('Leaderboard error:', error);
        console.error('Full error details:', error.message, error.code);
        tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 30px; color: #ff6b6b;">
            Error loading leaderboard: ${error.message}<br><small>Check console for details</small>
        </td></tr>`;
    }
}

function displayTeamStandings(teamTotals) {
    const teamLeaderboard = document.getElementById('teamLeaderboard');
    
    // Convert to array and sort by points
    const teams = Object.entries(teamTotals)
        .map(([name, data]) => ({ name, ...data }))
        .filter(team => team.members > 0)
        .sort((a, b) => b.points - a.points);

    if (teams.length === 0) {
        teamLeaderboard.innerHTML = '<p style="text-align: center; color: #999;">No teams assigned yet</p>';
        return;
    }

    teamLeaderboard.innerHTML = teams.map(team => `
        <div class="team-card team-${team.name}">
            <h3>${team.name.toUpperCase()} TEAM</h3>
            <div class="team-stat">${team.points} pts</div>
            <div class="team-members">${team.members} member${team.members !== 1 ? 's' : ''}</div>
        </div>
    `).join('');
}

        

        // Check-in window control
        async function checkCheckinWindow() {
            try {
                const windowDoc = await getDoc(doc(db, 'settings', 'checkinWindow'));
                const isOpen = windowDoc.exists() ? windowDoc.data().isOpen !== false : true;
                
                const banner = document.getElementById('checkinWindowBanner');
                const form = document.getElementById('checkinForm');
                const submitBtn = document.getElementById('checkinBtn');
                
                if (!isOpen) {
                    banner.innerHTML = `
                        <div class="checkin-closed-banner">
                            <strong>üö´ Check-In Window is Currently Closed</strong>
                            Check back later or contact your gym administrator.
                        </div>
                    `;
                    form.style.opacity = '0.5';
                    form.style.pointerEvents = 'none';
                    submitBtn.disabled = true;
                } else {
                    banner.innerHTML = `
                        <div class="checkin-open-banner">
                            ‚úÖ Check-in window is open! Submit your weekly progress below.
                        </div>
                    `;
                    form.style.opacity = '1';
                    form.style.pointerEvents = 'auto';
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Check window error:', error);
            }
        }

        window.toggleCheckinWindow = async function(open) {
            if (!isAdmin) return;

            try {
                await setDoc(doc(db, 'settings', 'checkinWindow'), {
                    isOpen: open,
                    lastUpdated: new Date().toISOString()
                });
                loadAdminData();
                checkCheckinWindow();
                alert(open ? 'Check-in window opened!' : 'Check-in window closed!');
            } catch (error) {
                console.error('Toggle window error:', error);
                alert('Failed to update check-in window');
            }
        };

// Admin Functions
async function loadAdminData() {
    if (!isAdmin) return;

    try {
        // Get all users
        const usersQuery = query(collection(db, 'users'));
        const usersSnapshot = await getDocs(usersQuery);
        const totalUsers = usersSnapshot.size;
        const visibleUsers = usersSnapshot.docs.filter(doc => !doc.data().hiddenFromLeaderboard).length;

        // Get all check-ins
        const checkinsQuery = query(collection(db, 'checkins'));
        const checkinsSnapshot = await getDocs(checkinsQuery);
        const totalCheckins = checkinsSnapshot.size;

        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('totalCheckins').textContent = totalCheckins;
        document.getElementById('visibleUsers').textContent = visibleUsers;

        // Load check-in window status
        const windowDoc = await getDoc(doc(db, 'settings', 'checkinWindow'));
        const isOpen = windowDoc.exists() ? windowDoc.data().isOpen !== false : true;
        const statusEl = document.getElementById('windowStatus');
        if (statusEl) {
            statusEl.textContent = isOpen ? 'OPEN' : 'CLOSED';
            statusEl.className = 'window-status ' + (isOpen ? 'open' : 'closed');
        }

        // Load team names
        const teamNamesDoc = await getDoc(doc(db, 'settings', 'teamNames'));
        if (teamNamesDoc.exists()) {
            const teamNames = teamNamesDoc.data();
            ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink', 'teal'].forEach(color => {
                const input = document.getElementById(`teamName_${color}`);
                if (input && teamNames[color]) {
                    input.value = teamNames[color];
                }
            });
        }

        // Load user list
        const userList = document.getElementById('adminUserList');
        userList.innerHTML = '';

        const users = [];
        usersSnapshot.forEach((doc) => {
            users.push({ uid: doc.id, ...doc.data() });
        });

        users.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));

        users.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            
            const teamBadge = user.team && user.team !== 'none' 
                ? `<span class="team-badge team-${user.team}">${user.team.toUpperCase()}</span>`
                : '<span style="color: #999; font-size: 0.9em;">No Team</span>';
            
            const captainBadge = user.isCaptain 
                ? '<span class="captain-badge">‚≠ê CAPTAIN</span>'
                : '';

        // Check if user is admin
            const isUserAdmin = ADMIN_EMAILS.includes(user.email.toLowerCase());
            
            const adminButtons = isUserAdmin
                ? `<span class="admin-badge">üëë ADMIN</span>
                   ${user.uid !== currentUser.uid ? `<button class="small-btn btn-danger" onclick="window.demoteFromAdmin('${user.email}', '${user.name}', '${user.uid}')">Remove Admin</button>` : ''}`
                : `<button class="promote-admin-btn" onclick="window.promoteToAdmin('${user.email}', '${user.name}', '${user.uid}')">üëë Make Admin</button>`;
                        
            userItem.innerHTML = `
                <div class="user-info">
                    <strong>${user.name}</strong> ${teamBadge} ${captainBadge}<br>
                    <small>${user.email} ‚Ä¢ ${user.totalPoints || 0} points</small>
                </div>
                <div class="user-actions">
                    <select class="team-select" onchange="window.assignTeam('${user.uid}', this.value)">
                        <option value="none" ${(!user.team || user.team === 'none') ? 'selected' : ''}>No Team</option>
                        <option value="red" ${user.team === 'red' ? 'selected' : ''}>üî¥ Red</option>
                        <option value="blue" ${user.team === 'blue' ? 'selected' : ''}>üîµ Blue</option>
                        <option value="green" ${user.team === 'green' ? 'selected' : ''}>üü¢ Green</option>
                        <option value="yellow" ${user.team === 'yellow' ? 'selected' : ''}>üü° Yellow</option>
                        <option value="purple" ${user.team === 'purple' ? 'selected' : ''}>üü£ Purple</option>
                        <option value="orange" ${user.team === 'orange' ? 'selected' : ''}>üü† Orange</option>
                        <option value="pink" ${user.team === 'pink' ? 'selected' : ''}>ü©∑ Pink</option>
                        <option value="teal" ${user.team === 'teal' ? 'selected' : ''}>ü©µ Teal</option>
                    </select>
                    <button class="small-btn ${user.isCaptain ? 'btn-show' : 'btn-secondary'}" 
                            onclick="window.toggleCaptain('${user.uid}', ${!user.isCaptain})"
                            style="${user.isCaptain ? 'background: gold; color: #333;' : ''}">
                        ${user.isCaptain ? '‚≠ê Captain' : 'Make Captain'}
                    </button>
                    ${adminButtons}
                    ${user.hiddenFromLeaderboard 
                        ? `<button class="small-btn btn-show" onclick="window.toggleUserVisibility('${user.uid}', false)">Show</button>`
                        : `<button class="small-btn btn-hide" onclick="window.toggleUserVisibility('${user.uid}', true)">Hide</button>`
                    }
                </div>
            `;
            userList.appendChild(userItem);
        });

        // Load adjustment tools
        loadAdjustmentUsers();
        loadAdjustmentHistory();

    } catch (error) {
        console.error('Admin data error:', error);
        console.error('Error details:', error.message);
    }
}

        window.toggleUserVisibility = async function(userId, hide) {
            if (!isAdmin) return;

            try {
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    hiddenFromLeaderboard: hide
                });
                loadAdminData();
                loadLeaderboard();
            } catch (error) {
                console.error('Toggle visibility error:', error);
                alert('Failed to update user visibility');
            }
        };

        window.assignTeam = async function(userId, team) {
            if (!isAdmin) return;

            try {
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    team: team
                });
                loadAdminData();
                loadLeaderboard();
            } catch (error) {
                console.error('Assign team error:', error);
                alert('Failed to assign team');
            }
        };

        window.toggleCaptain = async function(userId, makeCaptain) {
            if (!isAdmin) return;

            try {
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    isCaptain: makeCaptain
                });
                loadAdminData();
                loadTeamsPage();
            } catch (error) {
                console.error('Toggle captain error:', error);
                alert('Failed to update captain status');
            }
        };

        window.updateTeamName = async function(color, name) {
            if (!isAdmin) {
                console.error('Not admin - cannot update team names');
                return;
            }

            console.log('Attempting to update team name:', color, name);

            try {
                const teamNamesRef = doc(db, 'settings', 'teamNames');
                
                // Try to get existing document first
                let teamNamesDoc;
                try {
                    teamNamesDoc = await getDoc(teamNamesRef);
                } catch (getError) {
                    console.error('Error getting team names doc:', getError);
                    alert('Error accessing team names: ' + getError.message);
                    return;
                }
                
                const currentNames = teamNamesDoc.exists() ? teamNamesDoc.data() : {};
                currentNames[color] = name || null;

                console.log('Saving team names:', currentNames);
                
                await setDoc(teamNamesRef, currentNames);
                console.log('Team name saved successfully!');
                
                loadTeamsPage();
            } catch (error) {
                console.error('Update team name error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                alert('Failed to update team name: ' + error.code + ' - ' + error.message);
            }
        };

        // Load Teams Page
        async function loadTeamsPage() {
            const teamsContent = document.getElementById('teamsContent');
            teamsContent.innerHTML = '<p style="text-align: center; padding: 30px;">Loading teams...</p>';

            try {
                const q = query(collection(db, 'users'));
                const querySnapshot = await getDocs(q);
                
                // Get custom team names
                const teamNamesDoc = await getDoc(doc(db, 'settings', 'teamNames'));
                const teamNames = teamNamesDoc.exists() ? teamNamesDoc.data() : {};
                
                const teamGroups = {
                    red: [], blue: [], green: [], yellow: [],
                    purple: [], orange: [], pink: [], teal: [], none: []
                };

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (!userData.hiddenFromLeaderboard) {
                        const team = userData.team || 'none';
                        teamGroups[team].push({ uid: doc.id, ...userData });
                    }
                });

                // Sort each team by points
                Object.keys(teamGroups).forEach(team => {
                    teamGroups[team].sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
                });

                let html = '';

                // Show teams with members (sorted by total points)
                const teamColors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink', 'teal'];
                const teamsWithMembers = teamColors
                    .map(color => ({
                        color,
                        name: teamNames[color] || `${color.toUpperCase()} TEAM`,
                        members: teamGroups[color],
                        totalPoints: teamGroups[color].reduce((sum, m) => sum + (m.totalPoints || 0), 0)
                    }))
                    .filter(t => t.members.length > 0)
                    .sort((a, b) => b.totalPoints - a.totalPoints);

                teamsWithMembers.forEach(({ color, name, members, totalPoints }) => {
                    const captain = members.find(m => m.isCaptain);
                    
                    html += `
                        <div class="team-detail-section">
                            <div class="team-header team-${color} collapsed" onclick="toggleTeamAccordion(this)">
                                <div>
                                    <span class="team-color-label">üé® ${color}</span>
                                    <h3>${name}</h3>
                                    ${captain ? `<div style="font-size: 0.9em; margin-top: 5px;">‚≠ê Captain: ${captain.name}</div>` : ''}
                                </div>
                                <div class="team-total">
                                    <div class="label">${members.length} member${members.length !== 1 ? 's' : ''}</div>
                                    <div class="points">${totalPoints} pts</div>
                                </div>
                            </div>
                            <div class="team-members-container">
                                <div class="team-members-grid">
                                   ${members.map(member => {
    const isCurrentUser = currentUser && member.uid === currentUser.uid;
    const photoURL = member.photoURL || 
        `https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=4facfe&color=fff&size=60`;
    
    return `
        <div class="member-card ${isCurrentUser ? 'current-user' : ''} profile-clickable" 
             style="border-left-color: var(--team-${color});"
             onclick="viewUserProfile('${member.uid}')">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <img src="${photoURL}" class="profile-photo" alt="${member.name}">
                <div class="member-name">
                    ${member.name}
                    ${member.isCaptain ? '<span class="captain-badge">‚≠ê CAPTAIN</span>' : ''}
                    ${isCurrentUser ? ' <span style="color: #7ed957;">(You)</span>' : ''}
                </div>
            </div>
            <div class="member-points">${member.totalPoints || 0} pts</div>
        </div>
    `;
}).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Show unassigned members if any
                if (teamGroups.none.length > 0) {
                    html += `
                        <div class="no-team-section">
                            <h3 style="color: #856404; margin-bottom: 15px;">‚ö†Ô∏è Unassigned Members (${teamGroups.none.length})</h3>
                            <div class="team-members-grid">
                                ${teamGroups.none.map(member => {
                                    const isCurrentUser = currentUser && member.uid === currentUser.uid;
                                    return `
                                        <div class="member-card ${isCurrentUser ? 'current-user' : ''}" style="border-left-color: #ffc107;">
                                            <div class="member-name">
                                                ${member.name}
                                                ${isCurrentUser ? ' <span style="color: #7ed957;">(You)</span>' : ''}
                                            </div>
                                            <div class="member-points">${member.totalPoints || 0} pts</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                if (teamsWithMembers.length === 0 && teamGroups.none.length === 0) {
                    html = '<p style="text-align: center; padding: 50px; color: #999;">No teams or members yet!</p>';
                }

                teamsContent.innerHTML = html;

                // Add CSS variables for team colors
                const style = document.createElement('style');
                style.textContent = `
                    :root {
                        --team-red: #ff6b6b;
                        --team-blue: #4facfe;
                        --team-green: #7ed957;
                        --team-yellow: #ffd93d;
                        --team-purple: #a55eea;
                        --team-orange: #ff9f43;
                        --team-pink: #fd79a8;
                        --team-teal: #00d2d3;
                    }
                `;
                if (!document.getElementById('team-colors')) {
                    style.id = 'team-colors';
                    document.head.appendChild(style);
                }

            } catch (error) {
                console.error('Load teams error:', error);
                teamsContent.innerHTML = '<p style="text-align: center; padding: 30px; color: #ff6b6b;">Error loading teams</p>';
            }
        }

        // Toggle team accordion
        window.toggleTeamAccordion = function(header) {
            header.classList.toggle('collapsed');
            const container = header.nextElementSibling;
            container.classList.toggle('expanded');
        };

        window.exportTeamData = async function(teamColor) {
            if (!isAdmin) return;

            try {
                const usersQuery = query(collection(db, 'users'));
                const usersSnapshot = await getDocs(usersQuery);

                let csv = 'Name,Email,Team,Total Points,Hidden from Leaderboard,Registered At,Last Check-in\n';

                usersSnapshot.forEach((doc) => {
                    const user = doc.data();
                    if (user.team === teamColor) {
                        csv += `"${user.name}","${user.email}","${user.team || 'none'}",${user.totalPoints || 0},${user.hiddenFromLeaderboard ? 'Yes' : 'No'},"${user.registeredAt || ''}","${user.lastCheckin || ''}"\n`;
                    }
                });

                if (csv.split('\n').length <= 2) {
                    alert(`No members found on ${teamColor} team`);
                    return;
                }

                downloadCSV(csv, `reset-2026-${teamColor}-team.csv`);
            } catch (error) {
                console.error('Export team error:', error);
                alert('Failed to export team data');
            }
        };

        window.exportUsersCSV = async function() {
            if (!isAdmin) return;

            try {
                const usersQuery = query(collection(db, 'users'), orderBy('totalPoints', 'desc'));
                const usersSnapshot = await getDocs(usersQuery);

                let csv = 'Name,Email,Team,Total Points,Hidden from Leaderboard,Registered At,Last Check-in\n';

                usersSnapshot.forEach((doc) => {
                    const user = doc.data();
                    csv += `"${user.name}","${user.email}","${user.team || 'none'}",${user.totalPoints || 0},${user.hiddenFromLeaderboard ? 'Yes' : 'No'},"${user.registeredAt || ''}","${user.lastCheckin || ''}"\n`;
                });

                downloadCSV(csv, 'reset-2026-users.csv');
            } catch (error) {
                console.error('Export users error:', error);
                alert('Failed to export users');
            }
        };

        window.exportCheckinsCSV = async function() {
            if (!isAdmin) return;

            try {
                const checkinsQuery = query(collection(db, 'checkins'), orderBy('timestamp', 'desc'));
                const checkinsSnapshot = await getDocs(checkinsQuery);

                let csv = 'Name,Email,Weekly Score,Protein Days,Water Days,Classes,Recovery Days,Weekly Challenge,Alcohol Days,Late Days,Missed Check-in,Timestamp\n';

                checkinsSnapshot.forEach((doc) => {
                    const checkin = doc.data();
                    const d = checkin.details || {};
                    csv += `"${checkin.name}","${checkin.email}",${checkin.weeklyScore},${d.protein || 0},${d.water || 0},${d.classes || 0},${d.recovery || 0},${d.weekly || 0},${d.alcohol || 0},${d.late || 0},${d.missed || 0},"${checkin.timestamp}"\n`;
                });

                downloadCSV(csv, 'reset-2026-checkins.csv');
            } catch (error) {
                console.error('Export check-ins error:', error);
                alert('Failed to export check-ins');
            }
        };

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
// ===== LOCKER ROOM FUNCTIONS =====

        // Load weekly challenge
        async function loadWeeklyChallenge() {
    try {
        const challengeDoc = await getDoc(doc(db, 'settings', 'weeklyChallenge'));
        const challengeText = challengeDoc.exists() && challengeDoc.data().text 
            ? challengeDoc.data().text 
            : "No challenge set yet. Check back soon!";
        
        // Render with basic formatting
        let formatted = challengeText
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/^‚Ä¢ (.+)$/gm, '<li>$1</li>')
            .replace(/---/g, '<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 10px 0;">')
            .replace(/\n/g, '<br>');
        
        formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul style="margin: 10px 0; padding-left: 20px;">$1</ul>');
        
        document.getElementById('challengeText').innerHTML = formatted;
        
        if (isAdmin) {
            document.getElementById('editChallengeBtn').style.display = 'inline-block';
        }
    } catch (error) {
        console.error('Load challenge error:', error);
        document.getElementById('challengeText').textContent = "Error loading challenge";
    }
}
        // Edit challenge (admin only)
window.editChallenge = async function() {
    if (!isAdmin) return;

    const currentText = document.getElementById('challengeText').textContent;
    document.getElementById('challengeEditorText').value = currentText;
    updateChallengePreview();
    document.getElementById('challengeEditorModal').classList.add('active');
};

window.closeChallengeEditor = function() {
    document.getElementById('challengeEditorModal').classList.remove('active');
};

// Insert formatting text
window.insertText = function(before, after = '') {
    const textarea = document.getElementById('challengeEditorText');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    const newText = textarea.value.substring(0, start) + before + selectedText + after + textarea.value.substring(end);
    
    textarea.value = newText;
    textarea.focus();
    
    // Set cursor position
    if (selectedText) {
        textarea.setSelectionRange(start + before.length, end + before.length);
    } else {
        textarea.setSelectionRange(start + before.length, start + before.length);
    }
    
    updateChallengePreview();
};

// Update preview
function updateChallengePreview() {
    const text = document.getElementById('challengeEditorText').value;
    const preview = document.getElementById('challengePreview');
    
    // Simple markdown-like rendering
    let formatted = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
        .replace(/\*(.*?)\*/g, '<em>$1</em>')  // Italic
        .replace(/^‚Ä¢ (.+)$/gm, '<li>$1</li>')  // Bullet points
        .replace(/---/g, '<hr style="border: 1px solid #e0e0e0; margin: 10px 0;">')  // Divider
        .replace(/\n/g, '<br>');  // Line breaks
    
    // Wrap list items
    formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul style="margin: 10px 0; padding-left: 20px;">$1</ul>');
    
    preview.innerHTML = formatted || '<em style="color: #999;">Preview will appear here...</em>';
}

// Listen for text changes
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('challengeEditorText');
    if (editor) {
        editor.addEventListener('input', updateChallengePreview);
    }
});

// Save challenge from editor
window.saveChallengeFromEditor = async function() {
    if (!isAdmin) return;
    
    const text = document.getElementById('challengeEditorText').value.trim();
    
    if (!text) {
        alert('Please enter a challenge!');
        return;
    }
    
    try {
        await setDoc(doc(db, 'settings', 'weeklyChallenge'), {
            text: text,
            updatedBy: currentUser.email,
            updatedAt: new Date().toISOString()
        });
        
        // Update display with formatted version
        let formatted = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/^‚Ä¢ (.+)$/gm, '<li>$1</li>')
            .replace(/---/g, '<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 10px 0;">')
            .replace(/\n/g, '<br>');
        
        formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul style="margin: 10px 0; padding-left: 20px;">$1</ul>');
        
        document.getElementById('challengeText').innerHTML = formatted;
        closeChallengeEditor();
        alert('Challenge updated! ‚úÖ');
    } catch (error) {
        console.error('Update challenge error:', error);
        alert('Failed to update challenge: ' + error.message);
    }
};
        // Load messages
        async function loadMessages() {
            try {
                const q = query(collection(db, 'messages'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const messagesContainer = document.getElementById('messagesContainer');
                
                if (querySnapshot.empty) {
                    messagesContainer.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">No messages yet. Be the first to post!</p>';
                    return;
                }

                let html = '';
querySnapshot.forEach((doc) => {
    const msg = doc.data();
    const messageId = doc.id;
    const date = new Date(msg.timestamp);
    const timeAgo = getTimeAgo(date);
    
    // Get photo URL or default avatar
    const photoURL = msg.photoURL || 
        `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.userName)}&background=4facfe&color=fff&size=40`;
    
    const teamBadge = msg.team && msg.team !== 'none'
        ? `<span class="team-badge team-${msg.team}">${msg.team.toUpperCase()}</span>`
        : '';
    
    const deleteBtn = isAdmin 
        ? `<button class="delete-message-btn" onclick="deleteMessage('${messageId}')">Delete</button>`
        : '';
    
    html += `
        <div class="message-item">
            <div class="message-header">
                <div style="display: flex; align-items: center;">
                    <img src="${photoURL}" class="profile-photo small" alt="${msg.userName}">
                    <span class="message-author clickable-name" onclick="viewUserProfile('${msg.userId}')">${msg.userName}</span>
                    ${teamBadge}
                </div>
                <div>
                    <span class="message-timestamp">${timeAgo}</span>
                    ${deleteBtn}
                </div>
            </div>
            <div class="message-text">${escapeHtml(msg.text)}</div>
        </div>
    `;
});
                
                messagesContainer.innerHTML = html;
            } catch (error) {
                console.error('Load messages error:', error);
                document.getElementById('messagesContainer').innerHTML = 
                    '<p style="text-align: center; padding: 30px; color: #ff6b6b;">Error loading messages</p>';
            }
        }

        // Post message
        window.postMessage = async function() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter a message!');
                return;
            }
            
            if (text.length > 500) {
                alert('Message too long! Keep it under 500 characters.');
                return;
            }
            
            const btn = document.getElementById('postMessageBtn');
            btn.disabled = true;
            btn.textContent = 'Posting...';
            
            try {
                await addDoc(collection(db, 'messages'), {
                text: text,
                userName: currentUser.name,
                userId: currentUser.uid,
                team: currentUser.team || 'none',
                photoURL: currentUser.photoURL || null,
                timestamp: new Date().toISOString()
            });
                
                input.value = '';
                document.getElementById('charCounter').textContent = '0 / 500';
                loadMessages();
            } catch (error) {
                console.error('Post message error:', error);
                alert('Failed to post message: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì§ Post Message';
            }
        };

        // Delete message (admin only)
        window.deleteMessage = async function(messageId) {
            if (!isAdmin) return;
            
            if (!confirm('Delete this message?')) return;
            
            try {
                await deleteDoc(doc(db, 'messages', messageId));
                loadMessages();
            } catch (error) {
                console.error('Delete message error:', error);
                alert('Failed to delete message');
            }
        };

        // Character counter
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    const counter = document.getElementById('charCounter');
                    const length = this.value.length;
                    counter.textContent = `${length} / 500`;
                    counter.classList.toggle('warning', length > 450);
                });
            }
        });

        // Helper: Time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            
            return date.toLocaleDateString();
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        // ===== PROFILE FUNCTIONS =====

        // Load user profile
        async function loadUserProfile() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // Load profile fields
                    document.getElementById('profileNickname').value = userData.nickname || '';
                    document.getElementById('profileMovement').value = userData.favoriteMovement || '';
                    document.getElementById('profileVeggie').value = userData.favoriteVeggie || '';
                    document.getElementById('profileGoal').value = userData.challengeGoal || '';
                    
                    // Load profile photo
                    if (userData.photoURL) {
                        document.getElementById('profilePhotoDisplay').src = userData.photoURL;
                    } else {
                        const initials = currentUser.name.split(' ').map(n => n[0]).join('');
                        document.getElementById('profilePhotoDisplay').src = 
                            `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=4facfe&color=fff&size=120`;
                    }
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        // Save profile
        window.saveProfile = async function() {
            const nickname = document.getElementById('profileNickname').value.trim();
            const movement = document.getElementById('profileMovement').value.trim();
            const veggie = document.getElementById('profileVeggie').value.trim();
            const goal = document.getElementById('profileGoal').value.trim();
            
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    nickname: nickname || null,
                    favoriteMovement: movement || null,
                    favoriteVeggie: veggie || null,
                    challengeGoal: goal || null
                });
                
                // Update current user object
                currentUser.nickname = nickname;
                
                alert('Profile saved! ‚úÖ');
            } catch (error) {
                console.error('Save profile error:', error);
                alert('Failed to save profile: ' + error.message);
            }
        };

        // Upload profile photo with compression
window.uploadProfilePhoto = async function() {
    const fileInput = document.getElementById('photoUpload');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    // Check file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
        alert('Photo too large! Please use an image under 5MB.');
        return;
    }
    
    // Check file type
    if (!file.type.startsWith('image/')) {
        alert('Please upload an image file (JPG, PNG, or GIF)');
        return;
    }
    
    try {
        // Show loading state
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Uploading...';
        btn.disabled = true;
        
        // Compress image if it's large
        let fileToUpload = file;
        if (file.size > 500 * 1024) { // If larger than 500KB, compress
            fileToUpload = await compressImage(file);
        }
        
        // Upload to Firebase Storage
        const storageRef = ref(storage, `profile-photos/${currentUser.uid}`);
        await uploadBytes(storageRef, fileToUpload);
        
        // Get download URL
        const photoURL = await getDownloadURL(storageRef);
        
        // Update user document
        await updateDoc(doc(db, 'users', currentUser.uid), {
            photoURL: photoURL
        });
        
        // Update display
        document.getElementById('profilePhotoDisplay').src = photoURL;
        currentUser.photoURL = photoURL;
        
        alert('Photo uploaded! üì∏');
        
        // Reset button
        btn.textContent = originalText;
        btn.disabled = false;
    } catch (error) {
        console.error('Upload photo error:', error);
        alert('Failed to upload photo: ' + error.message);
        // Reset button
        event.target.textContent = 'üì∑ Upload Photo';
        event.target.disabled = false;
    }
};

// Compress image function
async function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            
            img.onload = () => {
                // Create canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate new dimensions (max 800px width/height)
                let width = img.width;
                let height = img.height;
                const maxDimension = 800;
                
                if (width > height && width > maxDimension) {
                    height = (height * maxDimension) / width;
                    width = maxDimension;
                } else if (height > maxDimension) {
                    width = (width * maxDimension) / height;
                    height = maxDimension;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Draw compressed image
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to blob with quality reduction
                canvas.toBlob((blob) => {
                    if (blob) {
                        resolve(new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        }));
                    } else {
                        reject(new Error('Compression failed'));
                    }
                }, 'image/jpeg', 0.8); // 80% quality
            };
            
            img.onerror = () => reject(new Error('Failed to load image'));
        };
        
        reader.onerror = () => reject(new Error('Failed to read file'));
    });
}

        // View another user's profile
        window.viewUserProfile = async function(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                console.log('User doc exists:', userDoc.exists());
                if (!userDoc.exists()) {
                    alert('User not found');
                    return;
                }
                
                const userData = userDoc.data();
                const displayName = userData.nickname || userData.name;
                const photoURL = userData.photoURL || 
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name)}&background=4facfe&color=fff&size=120`;
                
                const teamBadge = userData.team && userData.team !== 'none'
                    ? `<span class="team-badge team-${userData.team}">${userData.team.toUpperCase()}</span>`
                    : '';
                
                const modalContent = `
                    <h2>${displayName} ${teamBadge}</h2>
                    <div class="profile-container">
                        <img src="${photoURL}" class="profile-photo large" alt="Profile Photo">
                        <div>
                            <p style="font-size: 1.2em; font-weight: 600;">${userData.name}</p>
                            <p style="color: #666;">Total Points: <strong>${userData.totalPoints || 0}</strong></p>
                        </div>
                    </div>
                    <div class="profile-info-grid">
                        ${userData.favoriteMovement ? `
                        <div class="profile-info-item">
                            <label>Favorite Movement</label>
                            <div class="value">${userData.favoriteMovement}</div>
                        </div>` : ''}
                        ${userData.favoriteVeggie ? `
                        <div class="profile-info-item">
                            <label>Favorite Veggie</label>
                            <div class="value">${userData.favoriteVeggie}</div>
                        </div>` : ''}
                        ${userData.challengeGoal ? `
                        <div class="profile-info-item">
                            <label>#1 Goal</label>
                            <div class="value">${userData.challengeGoal}</div>
                        </div>` : ''}
                    </div>
                `;
                
                document.getElementById('profileModalContent').innerHTML = modalContent;
                document.getElementById('profileModal').classList.add('active');
                console.log('Modal should be visible now!');
            } catch (error) {
                console.error('View profile error:', error);
                alert('Failed to load profile');
            }
        };

        window.closeProfileModal = function() {
            document.getElementById('profileModal').classList.remove('active');
        };

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('profileModal');
            if (event.target === modal) {
                closeProfileModal();
            }
        };
        // ===== ADMIN TOOLS =====

        // Load users into adjustment dropdown
        async function loadAdjustmentUsers() {
            if (!isAdmin) return;
            
            try {
                const usersQuery = query(collection(db, 'users'));
                const usersSnapshot = await getDocs(usersQuery);
                
                const select = document.getElementById('adjustmentUser');
                select.innerHTML = '<option value="">Select User...</option>';
                
                const users = [];
                usersSnapshot.forEach((doc) => {
                    users.push({ uid: doc.id, ...doc.data() });
                });
                
                users.sort((a, b) => a.name.localeCompare(b.name));
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.uid;
                    option.textContent = `${user.name} (${user.totalPoints || 0} pts)`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Load adjustment users error:', error);
            }
        }

        // Apply point adjustment
        window.applyPointAdjustment = async function() {
            if (!isAdmin) return;
            
            const userId = document.getElementById('adjustmentUser').value;
            const points = parseInt(document.getElementById('adjustmentPoints').value);
            const reason = document.getElementById('adjustmentReason').value.trim();
            
            if (!userId) {
                alert('Please select a user');
                return;
            }
            
            if (isNaN(points) || points === 0) {
                alert('Please enter a point value (positive or negative)');
                return;
            }
            
            if (!reason) {
                alert('Please enter a reason for the adjustment');
                return;
            }
            
            try {
                // Update user points
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    totalPoints: increment(points)
                });
                
                // Log the adjustment
                await addDoc(collection(db, 'pointAdjustments'), {
                    userId: userId,
                    points: points,
                    reason: reason,
                    adjustedBy: currentUser.email,
                    timestamp: new Date().toISOString()
                });
                
                // Clear form
                document.getElementById('adjustmentUser').value = '';
                document.getElementById('adjustmentPoints').value = '';
                document.getElementById('adjustmentReason').value = '';
                
                alert(`${points > 0 ? 'Added' : 'Subtracted'} ${Math.abs(points)} points!`);
                
                loadAdjustmentHistory();
                loadAdjustmentUsers(); // Refresh point totals
                loadLeaderboard(); // Refresh leaderboard
            } catch (error) {
                console.error('Point adjustment error:', error);
                alert('Failed to adjust points: ' + error.message);
            }
        };

        // Load adjustment history
        async function loadAdjustmentHistory() {
            if (!isAdmin) return;
            
            try {
                const q = query(collection(db, 'pointAdjustments'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const historyDiv = document.getElementById('adjustmentHistory');
                
                if (querySnapshot.empty) {
                    historyDiv.innerHTML = '<h4 style="margin-bottom: 10px;">Recent Adjustments</h4><p style="color: #999; text-align: center; padding: 20px;">No adjustments yet</p>';
                    return;
                }
                
                let html = '<h4 style="margin-bottom: 10px;">Recent Adjustments</h4>';
                
                // Get user names
                const userNames = {};
                for (const adjustDoc of querySnapshot.docs) {
                    const adj = adjustDoc.data();
                    if (!userNames[adj.userId]) {
                        const userDoc = await getDoc(doc(db, 'users', adj.userId));
                        if (userDoc.exists()) {
                            userNames[adj.userId] = userDoc.data().name;
                        }
                    }
                }
                
                querySnapshot.forEach((adjustDoc) => {
                    const adj = adjustDoc.data();
                    const date = new Date(adj.timestamp);
                    const timeAgo = getTimeAgo(date);
                    const userName = userNames[adj.userId] || 'Unknown User';
                    const pointsClass = adj.points > 0 ? 'positive' : 'negative';
                    const pointsSign = adj.points > 0 ? '+' : '';
                    
                    html += `
                        <div class="adjustment-item ${pointsClass}">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>${userName}</strong>
                                <strong style="color: ${adj.points > 0 ? '#7ed957' : '#ff6b6b'};">
                                    ${pointsSign}${adj.points} pts
                                </strong>
                            </div>
                            <div style="color: #666; font-size: 0.95em;">${adj.reason}</div>
                            <div style="color: #999; font-size: 0.85em; margin-top: 5px;">
                                ${timeAgo} ‚Ä¢ by ${adj.adjustedBy}
                            </div>
                        </div>
                    `;
                });
                
                historyDiv.innerHTML = html;
            } catch (error) {
                console.error('Load adjustment history error:', error);
            }
        }

        // Promote to admin (automatic)
window.promoteToAdmin = async function(email, name, userId) {
    if (!isAdmin) return;
    
    const confirmed = confirm(
        `Promote ${name} (${email}) to admin?\n\n` +
        `This will give them:\n` +
        `‚Ä¢ Access to admin panel\n` +
        `‚Ä¢ Ability to edit teams & captains\n` +
        `‚Ä¢ Ability to adjust points\n` +
        `‚Ä¢ Ability to manage check-in window\n\n` +
        `They will have admin access immediately!`
    );
    
    if (!confirmed) return;
    
    try {
        // Add to adminUsers collection
        await setDoc(doc(db, 'adminUsers', userId), {
            email: email,
            name: name,
            promotedBy: currentUser.email,
            promotedAt: new Date().toISOString()
        });
        
        // Add to ADMIN_EMAILS array in memory (for current session)
        if (!ADMIN_EMAILS.includes(email.toLowerCase())) {
            ADMIN_EMAILS.push(email.toLowerCase());
        }
        
        // Reload admin data to show the admin badge
        loadAdminData();
        
        alert(`‚úÖ ${name} is now an admin!\n\nThey'll see the Admin tab next time they log in.`);
    } catch (error) {
        console.error('Promote to admin error:', error);
        alert('Failed to promote to admin: ' + error.message);
    }
};

// Demote from admin
window.demoteFromAdmin = async function(email, name, userId) {
    if (!isAdmin) return;
    
    // Don't let them demote themselves
    if (userId === currentUser.uid) {
        alert("You can't demote yourself!");
        return;
    }
    
    const confirmed = confirm(
        `Remove admin access from ${name}?\n\n` +
        `They will lose access to the admin panel.`
    );
    
    if (!confirmed) return;
    
    try {
        // Remove from adminUsers collection
        await deleteDoc(doc(db, 'adminUsers', userId));
        
        // Remove from ADMIN_EMAILS array in memory
        const index = ADMIN_EMAILS.indexOf(email.toLowerCase());
        if (index > -1) {
            ADMIN_EMAILS.splice(index, 1);
        }
        
        // Reload admin data
        loadAdminData();
        
        alert(`‚úÖ ${name}'s admin access has been removed.`);
    } catch (error) {
        console.error('Demote from admin error:', error);
        alert('Failed to remove admin access: ' + error.message);
    }
};
        // Load admin users from database
async function loadAdminUsers() {
    try {
        const adminQuery = query(collection(db, 'adminUsers'));
        const adminSnapshot = await getDocs(adminQuery);
        
        // Keep original hardcoded admins
        const hardcodedAdmins = ADMIN_EMAILS.slice();
        ADMIN_EMAILS.length = 0;
        
        // Add back hardcoded admins
        hardcodedAdmins.forEach(email => ADMIN_EMAILS.push(email));
        
        // Add database admins
        adminSnapshot.forEach((doc) => {
            const adminData = doc.data();
            if (!ADMIN_EMAILS.includes(adminData.email.toLowerCase())) {
                ADMIN_EMAILS.push(adminData.email.toLowerCase());
            }
        });
        
        console.log('Loaded admin users:', ADMIN_EMAILS);
    } catch (error) {
        console.error('Load admin users error:', error);
    }
}
        // Initialize
        updateTotalScore();
    </script>
</body>
</html>
