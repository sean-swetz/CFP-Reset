<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset 2026 Challenge Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 {
            color: #4facfe;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7ed957;
            font-size: 1.2em;
            font-weight: 600;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h2 {
            color: #4facfe;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #4facfe;
        }

        .challenge-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .challenge-header {
            margin-bottom: 12px;
        }

        .challenge-name {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .challenge-points {
            color: #7ed957;
            font-weight: 700;
            font-size: 0.9em;
        }

        .days-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .day-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .day-checkbox label {
            font-size: 0.85em;
            font-weight: 600;
            color: #666;
            margin: 0;
        }

        .day-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #7ed957;
        }

        .single-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .single-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #7ed957;
        }

        .single-checkbox.deduction input[type="checkbox"] {
            accent-color: #ff6b6b;
        }

        .single-checkbox label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .deduction-item {
            background: #fff3f3;
            border-left: 4px solid #ff6b6b;
        }

        .deduction-points {
            color: #ff6b6b;
        }

        .btn {
            background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(126, 217, 87, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #3d8fd1 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .total-score {
            background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            font-size: 1.5em;
            font-weight: 700;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th {
            background: linear-gradient(135deg, #4facfe 0%, #3d8fd1 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .leaderboard-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .leaderboard-table tr:hover {
            background: #f8f9fa;
        }

        .rank {
            font-weight: 700;
            font-size: 1.2em;
            color: #4facfe;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: white;
            border: 2px solid #4facfe;
            color: #4facfe;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #4facfe;
            color: white;
        }

        .nav-btn.admin {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .nav-btn.admin.active {
            background: #ff6b6b;
            color: white;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .login-container {
            max-width: 450px;
            margin: 50px auto;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: white;
            border: 2px solid #4facfe;
            color: #4facfe;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }

        .auth-tab.active {
            background: #4facfe;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .logged-in-user {
            background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .logout-btn {
            background: white;
            color: #5cb85c;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .forgot-password {
            text-align: center;
            margin-top: 15px;
        }

        .forgot-password a {
            color: #4facfe;
            text-decoration: none;
            font-weight: 600;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .admin-card h3 {
            color: #4facfe;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .admin-card .stat {
            font-size: 2em;
            font-weight: 700;
            color: #7ed957;
        }

        .export-section {
            margin-top: 30px;
        }

        #app {
            display: none;
        }

        #app.active {
            display: block;
        }

        #authPage {
            display: block;
        }

        #authPage.hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }

        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .user-info {
            flex: 1;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .small-btn {
            padding: 6px 12px;
            font-size: 0.9em;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-hide {
            background: #ffc107;
            color: #000;
        }

        .btn-show {
            background: #28a745;
            color: white;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 1.8em;
            }
            
            .challenge-item {
                gap: 15px;
            }
            
            .days-grid {
                width: 100%;
                justify-content: space-between;
            }

            .day-checkbox {
                flex: 1;
                min-width: 40px;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading Reset 2026...</div>

    <!-- Authentication Page -->
    <div id="authPage" style="display: none;">
        <div class="login-container">
            <div class="header">
                <h1>RESET 2026</h1>
                <p class="subtitle">Nutrition & Fitness Challenge</p>
            </div>

            <div class="card">
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="showAuthTab('login')">Login</div>
                    <div class="auth-tab" onclick="showAuthTab('register')">Register</div>
                </div>

                <div class="error-message" id="authError"></div>
                <div class="success-message" id="authSuccess"></div>

                <!-- Login Form -->
                <form id="loginForm" class="auth-form active">
                    <h2>Welcome Back!</h2>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn" id="loginBtn">Login</button>
                    <div class="forgot-password">
                        <a href="#" onclick="showAuthTab('reset'); return false;">Forgot Password?</a>
                    </div>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="auth-form">
                    <h2>Join the Challenge</h2>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="regName" required>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="regPassword" required minlength="6">
                    </div>
                    <button type="submit" class="btn" id="registerBtn">Create Account</button>
                </form>

                <!-- Password Reset Form -->
                <form id="resetForm" class="auth-form">
                    <h2>Reset Password</h2>
                    <p style="color: #666; margin-bottom: 20px;">Enter your email address and we'll send you a link to reset your password.</p>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="resetEmail" required>
                    </div>
                    <button type="submit" class="btn" id="resetBtn">Send Reset Link</button>
                    <div class="forgot-password">
                        <a href="#" onclick="showAuthTab('login'); return false;">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="app" class="container" style="display: none;">
        <div class="header">
            <h1>RESET 2026</h1>
            <p class="subtitle">Nutrition & Fitness Challenge Tracker</p>
        </div>

        <div class="logged-in-user">
            <span id="userGreeting">Welcome!</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showSection('checkin')">Check In</button>
            <button class="nav-btn" onclick="showSection('leaderboard')">Leaderboard</button>
            <button class="nav-btn admin" id="adminNavBtn" onclick="showSection('admin')" style="display: none;">Admin</button>
        </div>

        <!-- Check In Section -->
        <div id="checkin" class="section active">
            <div class="card">
                <h2>Weekly Check-In</h2>
                <div class="success-message" id="checkinSuccess"></div>
                <form id="checkinForm">
                    <h3 style="color: #7ed957; margin: 30px 0 15px 0;">üí™ Earn Points</h3>
                    
                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Hit Protein Goal</span>
                            <span class="challenge-points">+5 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_mon" class="protein-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_tue" class="protein-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_wed" class="protein-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_thu" class="protein-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_fri" class="protein-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_sat" class="protein-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_sun" class="protein-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Hit Water Goal</span>
                            <span class="challenge-points">+5 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_mon" class="water-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_tue" class="water-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_wed" class="water-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_thu" class="water-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_fri" class="water-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_sat" class="water-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_sun" class="water-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Attended 3+ Classes This Week</span>
                            <span class="challenge-points">+15 pts</span>
                        </div>
                        <div class="single-checkbox">
                            <input type="checkbox" id="classes">
                            <label for="classes">Completed</label>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Stretching/Yoga/Recovery</span>
                            <span class="challenge-points">+3 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_mon" class="recovery-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_tue" class="recovery-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_wed" class="recovery-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_thu" class="recovery-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_fri" class="recovery-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_sat" class="recovery-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_sun" class="recovery-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Completed Weekly Challenge</span>
                            <span class="challenge-points">+20 pts</span>
                        </div>
                        <div class="single-checkbox">
                            <input type="checkbox" id="weekly">
                            <label for="weekly">Completed</label>
                        </div>
                    </div>

                    <h3 style="color: #ff6b6b; margin: 30px 0 15px 0;">‚ö†Ô∏è Deductions</h3>

                    <div class="challenge-item deduction-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Consumed Alcohol</span>
                            <span class="challenge-points deduction-points">-5 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_mon" class="alcohol-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_tue" class="alcohol-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_wed" class="alcohol-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_thu" class="alcohol-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_fri" class="alcohol-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_sat" class="alcohol-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_sun" class="alcohol-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item deduction-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Late to Class</span>
                            <span class="challenge-points deduction-points">-3 pts/occurrence</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_mon" class="late-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_tue" class="late-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_wed" class="late-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_thu" class="late-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_fri" class="late-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_sat" class="late-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_sun" class="late-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item deduction-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Missed Weekly Check-In</span>
                            <span class="challenge-points deduction-points">-10 pts</span>
                        </div>
                        <div class="single-checkbox deduction">
                            <input type="checkbox" id="missed">
                            <label for="missed">Yes, I missed last week</label>
                        </div>
                    </div>

                    <div class="total-score" id="totalScore">
                        Total Weekly Score: 0 points
                    </div>

                    <button type="submit" class="btn" id="checkinBtn">Submit Check-In</button>
                </form>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboard" class="section">
            <div class="card">
                <h2>üèÜ Leaderboard</h2>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Total Points</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr><td colspan="3" style="text-align: center; padding: 30px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="admin" class="section">
            <div class="card">
                <h2>üîß Admin Dashboard</h2>
                <div class="info-message">
                    <strong>Admin Access:</strong> You can export data and manage user visibility on the leaderboard.
                </div>

                <div class="admin-controls">
                    <div class="admin-card">
                        <h3>Total Users</h3>
                        <div class="stat" id="totalUsers">0</div>
                    </div>
                    <div class="admin-card">
                        <h3>Total Check-ins</h3>
                        <div class="stat" id="totalCheckins">0</div>
                    </div>
                    <div class="admin-card">
                        <h3>Visible Users</h3>
                        <div class="stat" id="visibleUsers">0</div>
                    </div>
                </div>

                <div class="export-section">
                    <h3>Export Data</h3>
                    <p style="margin-bottom: 15px; color: #666;">Download all user and check-in data as CSV files for analysis.</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportUsersCSV()" style="flex: 1; min-width: 200px;">
                            üìä Export All Users
                        </button>
                        <button class="btn btn-secondary" onclick="exportCheckinsCSV()" style="flex: 1; min-width: 200px;">
                            üìã Export All Check-ins
                        </button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Manage User Visibility</h3>
                    <p style="margin-bottom: 15px; color: #666;">Hide users from the leaderboard (they can still check in and see their own progress).</p>
                    <div class="user-list" id="adminUserList">
                        <p style="text-align: center; padding: 20px;">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, where, getDocs, updateDoc, increment, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // REPLACE THESE WITH YOUR FIREBASE CONFIG
       const firebaseConfig = {
  apiKey: "AIzaSyDbvV8uX5OnPRJChm6Q58ca7lyvHg2jqRo",
  authDomain: "reset-2026-tracker.firebaseapp.com",
  projectId: "reset-2026-tracker",
  storageBucket: "reset-2026-tracker.firebasestorage.app",
  messagingSenderId: "867262535384",
  appId: "1:867262535384:web:a9d18d62159c657f4ca9ad"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ADMIN EMAIL - Change this to YOUR email address
        const ADMIN_EMAIL = "seanswetz@pm.me";

        let currentUser = null;
        let isAdmin = false;

        // Hide loading screen
        document.getElementById('loading').style.display = 'none';

        // Check auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    isAdmin = user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
                    showApp();
                }
            } else {
                showAuthPage();
            }
        });

        function showApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('userGreeting').textContent = `Welcome, ${currentUser.name}!${isAdmin ? ' (Admin)' : ''}`;
            
            if (isAdmin) {
                document.getElementById('adminNavBtn').style.display = 'block';
            }
            
            loadLeaderboard();
        }

        function showAuthPage() {
            document.getElementById('authPage').style.display = 'block';
            document.getElementById('app').style.display = 'none';
        }

        // Auth tab switching
        window.showAuthTab = function(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else if (tab === 'register') {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            } else if (tab === 'reset') {
                document.getElementById('resetForm').classList.add('active');
            }
            hideMessages();
        };

        function hideMessages() {
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showAuthSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 5000);
        }

        // Registration
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const btn = document.getElementById('registerBtn');

            btn.disabled = true;
            btn.textContent = 'Creating Account...';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    totalPoints: 0,
                    hiddenFromLeaderboard: false,
                    registeredAt: new Date().toISOString()
                });

                showAuthSuccess('Account created successfully!');
                document.getElementById('registerForm').reset();
                setTimeout(() => window.showAuthTab('login'), 2000);
            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showAuthError('This email is already registered. Please login instead.');
                } else if (error.code === 'auth/weak-password') {
                    showAuthError('Password should be at least 6 characters.');
                } else {
                    showAuthError('Registration failed. Please try again.');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.textContent = 'Logging in...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    showAuthError('Invalid email or password.');
                } else {
                    showAuthError('Login failed. Please try again.');
                }
                btn.disabled = false;
                btn.textContent = 'Login';
            }
        });

        // Password Reset
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const email = document.getElementById('resetEmail').value;
            const btn = document.getElementById('resetBtn');

            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                await sendPasswordResetEmail(auth, email);
                showAuthSuccess('Password reset email sent! Check your inbox.');
                document.getElementById('resetForm').reset();
                setTimeout(() => window.showAuthTab('login'), 3000);
            } catch (error) {
                console.error('Reset error:', error);
                if (error.code === 'auth/user-not-found') {
                    showAuthError('No account found with this email.');
                } else {
                    showAuthError('Failed to send reset email. Please try again.');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Reset Link';
            }
        });

        // Logout
        window.logout = async function() {
            try {
                await signOut(auth);
                currentUser = null;
                isAdmin = false;
                document.getElementById('loginForm').reset();
                document.getElementById('adminNavBtn').style.display = 'none';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // Navigation
        window.showSection = function(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            if (sectionName === 'leaderboard') {
                loadLeaderboard();
            } else if (sectionName === 'admin' && isAdmin) {
                loadAdminData();
            }
        };

        // Calculate total score
        function updateTotalScore() {
            const protein = document.querySelectorAll('.protein-check:checked').length;
            const water = document.querySelectorAll('.water-check:checked').length;
            const classes = document.getElementById('classes').checked ? 1 : 0;
            const recovery = document.querySelectorAll('.recovery-check:checked').length;
            const weekly = document.getElementById('weekly').checked ? 1 : 0;
            const alcohol = document.querySelectorAll('.alcohol-check:checked').length;
            const late = document.querySelectorAll('.late-check:checked').length;
            const missed = document.getElementById('missed').checked ? 1 : 0;

            const total = (protein * 5) + (water * 5) + (classes * 15) + 
                         (recovery * 3) + (weekly * 20) - (alcohol * 5) - 
                         (late * 3) - (missed * 10);

            document.getElementById('totalScore').textContent = 
                `Total Weekly Score: ${total} points`;
        }

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateTotalScore);
        });

        // Check-in Form
        document.getElementById('checkinForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) return;

            const btn = document.getElementById('checkinBtn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            const protein = document.querySelectorAll('.protein-check:checked').length;
            const water = document.querySelectorAll('.water-check:checked').length;
            const classes = document.getElementById('classes').checked ? 1 : 0;
            const recovery = document.querySelectorAll('.recovery-check:checked').length;
            const weekly = document.getElementById('weekly').checked ? 1 : 0;
            const alcohol = document.querySelectorAll('.alcohol-check:checked').length;
            const late = document.querySelectorAll('.late-check:checked').length;
            const missed = document.getElementById('missed').checked ? 1 : 0;

            const weeklyScore = (protein * 5) + (water * 5) + (classes * 15) + 
                               (recovery * 3) + (weekly * 20) - (alcohol * 5) - 
                               (late * 3) - (missed * 10);

            try {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    totalPoints: increment(weeklyScore),
                    lastCheckin: new Date().toISOString()
                });

                await addDoc(collection(db, 'checkins'), {
                    userId: currentUser.uid,
                    name: currentUser.name,
                    email: currentUser.email,
                    weeklyScore: weeklyScore,
                    details: { protein, water, classes, recovery, weekly, alcohol, late, missed },
                    timestamp: new Date().toISOString()
                });

                currentUser.totalPoints = (currentUser.totalPoints || 0) + weeklyScore;

                const successMsg = document.getElementById('checkinSuccess');
                successMsg.textContent = `Check-in submitted! You earned ${weeklyScore} points this week. Your total is now ${currentUser.totalPoints} points.`;
                successMsg.style.display = 'block';
                
                document.getElementById('checkinForm').reset();
                updateTotalScore();

                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 5000);

            } catch (error) {
                console.error('Check-in error:', error);
                alert('Failed to submit check-in. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit Check-In';
            }
        });

        // Load Leaderboard
        async function loadLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px;">Loading...</td></tr>';

            try {
                const q = query(
                    collection(db, 'users'), 
                    where('hiddenFromLeaderboard', '==', false),
                    orderBy('totalPoints', 'desc')
                );
                const querySnapshot = await getDocs(q);
                
                const leaderboardData = [];
                querySnapshot.forEach((doc) => {
                    leaderboardData.push({ uid: doc.id, ...doc.data() });
                });

                tbody.innerHTML = '';
                if (leaderboardData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">No check-ins yet. Be the first!</td></tr>';
                    return;
                }

                leaderboardData.forEach((member, index) => {
                    const row = tbody.insertRow();
                    const rankClass = index < 3 ? `rank-${index + 1}` : '';
                    const isCurrentUser = currentUser && member.uid === currentUser.uid;
                    row.style.background = isCurrentUser ? '#e8f5e9' : '';
                    row.innerHTML = `
                        <td><span class="rank ${rankClass}">${index + 1}</span></td>
                        <td>${member.name}${isCurrentUser ? ' (You)' : ''}</td>
                        <td><strong>${member.totalPoints || 0} pts</strong></td>
                    `;
                });

            } catch (error) {
                console.error('Leaderboard error:', error);
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px;">Error loading leaderboard</td></tr>';
            }
        }

        window.loadLeaderboard = loadLeaderboard;

        // Admin Functions
        async function loadAdminData() {
            if (!isAdmin) return;

            try {
                // Get all users
                const usersQuery = query(collection(db, 'users'));
                const usersSnapshot = await getDocs(usersQuery);
                const totalUsers = usersSnapshot.size;
                const visibleUsers = usersSnapshot.docs.filter(doc => !doc.data().hiddenFromLeaderboard).length;

                // Get all check-ins
                const checkinsQuery = query(collection(db, 'checkins'));
                const checkinsSnapshot = await getDocs(checkinsQuery);
                const totalCheckins = checkinsSnapshot.size;

                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('totalCheckins').textContent = totalCheckins;
                document.getElementById('visibleUsers').textContent = visibleUsers;

                // Load user list
                const userList = document.getElementById('adminUserList');
                userList.innerHTML = '';

                const users = [];
                usersSnapshot.forEach((doc) => {
                    users.push({ uid: doc.id, ...doc.data() });
                });

                users.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));

                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                        <div class="user-info">
                            <strong>${user.name}</strong><br>
                            <small>${user.email} ‚Ä¢ ${user.totalPoints || 0} points</small>
                        </div>
                        <div class="user-actions">
                            ${user.hiddenFromLeaderboard 
                                ? `<button class="small-btn btn-show" onclick="window.toggleUserVisibility('${user.uid}', false)">Show on Leaderboard</button>`
                                : `<button class="small-btn btn-hide" onclick="window.toggleUserVisibility('${user.uid}', true)">Hide from Leaderboard</button>`
                            }
                        </div>
                    `;
                    userList.appendChild(userItem);
                });

            } catch (error) {
                console.error('Admin data error:', error);
            }
        }

        window.toggleUserVisibility = async function(userId, hide) {
            if (!isAdmin) return;

            try {
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    hiddenFromLeaderboard: hide
                });
                loadAdminData();
                loadLeaderboard();
            } catch (error) {
                console.error('Toggle visibility error:', error);
                alert('Failed to update user visibility');
            }
        };

        window.exportUsersCSV = async function() {
            if (!isAdmin) return;

            try {
                const usersQuery = query(collection(db, 'users'), orderBy('totalPoints', 'desc'));
                const usersSnapshot = await getDocs(usersQuery);

                let csv = 'Name,Email,Total Points,Hidden from Leaderboard,Registered At,Last Check-in\n';

                usersSnapshot.forEach((doc) => {
                    const user = doc.data();
                    csv += `"${user.name}","${user.email}",${user.totalPoints || 0},${user.hiddenFromLeaderboard ? 'Yes' : 'No'},"${user.registeredAt || ''}","${user.lastCheckin || ''}"\n`;
                });

                downloadCSV(csv, 'reset-2026-users.csv');
            } catch (error) {
                console.error('Export users error:', error);
                alert('Failed to export users');
            }
        };

        window.exportCheckinsCSV = async function() {
            if (!isAdmin) return;

            try {
                const checkinsQuery = query(collection(db, 'checkins'), orderBy('timestamp', 'desc'));
                const checkinsSnapshot = await getDocs(checkinsQuery);

                let csv = 'Name,Email,Weekly Score,Protein Days,Water Days,Classes,Recovery Days,Weekly Challenge,Alcohol Days,Late Days,Missed Check-in,Timestamp\n';

                checkinsSnapshot.forEach((doc) => {
                    const checkin = doc.data();
                    const d = checkin.details || {};
                    csv += `"${checkin.name}","${checkin.email}",${checkin.weeklyScore},${d.protein || 0},${d.water || 0},${d.classes || 0},${d.recovery || 0},${d.weekly || 0},${d.alcohol || 0},${d.late || 0},${d.missed || 0},"${checkin.timestamp}"\n`;
                });

                downloadCSV(csv, 'reset-2026-checkins.csv');
            } catch (error) {
                console.error('Export check-ins error:', error);
                alert('Failed to export check-ins');
            }
        };

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Initialize
        updateTotalScore();
    </script>
</body>
</html>
