<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset 2026 Challenge Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 {
            color: #4facfe;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7ed957;
            font-size: 1.2em;
            font-weight: 600;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h2 {
            color: #4facfe;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #4facfe;
        }

        .challenge-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .challenge-header {
            margin-bottom: 12px;
        }

        .challenge-name {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .challenge-points {
            color: #7ed957;
            font-weight: 700;
            font-size: 0.9em;
        }

        .days-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .day-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .day-checkbox label {
            font-size: 0.85em;
            font-weight: 600;
            color: #666;
            margin: 0;
        }

        .day-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #7ed957;
        }

        .single-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .single-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #7ed957;
        }

        .single-checkbox.deduction input[type="checkbox"] {
            accent-color: #ff6b6b;
        }

        .single-checkbox label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .deduction-item {
            background: #fff3f3;
            border-left: 4px solid #ff6b6b;
        }

        .deduction-points {
            color: #ff6b6b;
        }

        .btn {
            background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(126, 217, 87, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #3d8fd1 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .total-score {
            background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            font-size: 1.5em;
            font-weight: 700;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th {
            background: linear-gradient(135deg, #4facfe 0%, #3d8fd1 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .leaderboard-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .leaderboard-table tr:hover {
            background: #f8f9fa;
        }

        .rank {
            font-weight: 700;
            font-size: 1.2em;
            color: #4facfe;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: white;
            border: 2px solid #4facfe;
            color: #4facfe;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #4facfe;
            color: white;
        }

        .nav-btn.admin {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .nav-btn.admin.active {
            background: #ff6b6b;
            color: white;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .login-container {
            max-width: 450px;
            margin: 50px auto;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: white;
            border: 2px solid #4facfe;
            color: #4facfe;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }

        .auth-tab.active {
            background: #4facfe;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .logged-in-user {
            background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .logout-btn {
            background: white;
            color: #5cb85c;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .forgot-password {
            text-align: center;
            margin-top: 15px;
        }

        .forgot-password a {
            color: #4facfe;
            text-decoration: none;
            font-weight: 600;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .admin-card h3 {
            color: #4facfe;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .admin-card .stat {
            font-size: 2em;
            font-weight: 700;
            color: #7ed957;
        }

        .export-section {
            margin-top: 30px;
        }

        #app {
            display: none;
        }

        #app.active {
            display: block;
        }

        #authPage {
            display: block;
        }

        #authPage.hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }

        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .user-info {
            flex: 1;
        }

        .user-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .small-btn {
            padding: 6px 12px;
            font-size: 0.9em;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-hide {
            background: #ffc107;
            color: #000;
        }

        .btn-show {
            background: #28a745;
            color: white;
        }

        .team-select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
            font-weight: 600;
            cursor: pointer;
        }

        .team-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            color: white;
            margin-left: 8px;
        }

        .team-red { background: #ff6b6b; }
        .team-blue { background: #4facfe; }
        .team-green { background: #7ed957; }
        .team-yellow { background: #ffd93d; color: #333; }
        .team-purple { background: #a55eea; }
        .team-orange { background: #ff9f43; }
        .team-pink { background: #fd79a8; }
        .team-teal { background: #00d2d3; }

        .team-leaderboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .team-card {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .team-card h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .team-card .team-stat {
            font-size: 2em;
            font-weight: 700;
        }

        .team-card .team-members {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .captain-badge {
            display: inline-block;
            padding: 3px 10px;
            background: gold;
            color: #333;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 700;
            margin-left: 8px;
        }

        .team-detail-section {
            margin-bottom: 40px;
        }

        .team-header {
            padding: 20px;
            padding-right: 60px;
            border-radius: 15px;
            color: white;
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .team-header:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .team-header::after {
            content: '‚ñº';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .team-header.collapsed::after {
            transform: translateY(-50%) rotate(-90deg);
        }

        .team-members-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s, padding 0.3s;
            opacity: 0;
            padding-top: 0;
        }

        .team-members-container.expanded {
            max-height: 2000px;
            opacity: 1;
            padding-top: 20px;
        }

        .team-name-input {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1em;
            margin-left: 10px;
            width: 200px;
        }

        .team-name-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .team-color-label {
            font-size: 0.8em;
            opacity: 0.8;
            display: block;
            margin-bottom: 5px;
        }

        .team-header h3 {
            font-size: 2em;
            margin: 0;
        }

        .team-total {
            text-align: right;
        }

        .team-total .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .team-total .points {
            font-size: 2em;
            font-weight: 700;
        }

        .team-members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .member-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid;
        }

        .member-card.current-user {
            background: #e8f5e9;
            border-left-width: 6px;
        }

        .member-name {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .member-points {
            font-size: 1.5em;
            font-weight: 700;
            color: #4facfe;
        }

        .no-team-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
        }

        .checkin-closed-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 600;
        }

        .checkin-closed-banner strong {
            display: block;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .checkin-open-banner {
            background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .window-control {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .window-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            margin-left: 10px;
        }

        .window-status.open {
            background: #d4edda;
            color: #155724;
        }

        .window-status.closed {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 1.8em;
            }
            
            .challenge-item {
                gap: 15px;
            }
            
            .days-grid {
                width: 100%;
                justify-content: space-between;
            }

            .day-checkbox {
                flex: 1;
                min-width: 40px;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading Reset 2026...</div>

    <!-- Authentication Page -->
    <div id="authPage" style="display: none;">
        <div class="login-container">
            <div class="header">
                <h1>RESET 2026</h1>
                <p class="subtitle">Nutrition & Fitness Challenge</p>
            </div>

            <div class="card">
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="showAuthTab('login')">Login</div>
                    <div class="auth-tab" onclick="showAuthTab('register')">Register</div>
                </div>

                <div class="error-message" id="authError"></div>
                <div class="success-message" id="authSuccess"></div>

                <!-- Login Form -->
                <form id="loginForm" class="auth-form active">
                    <h2>Welcome Back!</h2>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn" id="loginBtn">Login</button>
                    <div class="forgot-password">
                        <a href="#" onclick="showAuthTab('reset'); return false;">Forgot Password?</a>
                    </div>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="auth-form">
                    <h2>Join the Challenge</h2>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="regName" required>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="regPassword" required minlength="6">
                    </div>
                    <button type="submit" class="btn" id="registerBtn">Create Account</button>
                </form>

                <!-- Password Reset Form -->
                <form id="resetForm" class="auth-form">
                    <h2>Reset Password</h2>
                    <p style="color: #666; margin-bottom: 20px;">Enter your email address and we'll send you a link to reset your password.</p>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="resetEmail" required>
                    </div>
                    <button type="submit" class="btn" id="resetBtn">Send Reset Link</button>
                    <div class="forgot-password">
                        <a href="#" onclick="showAuthTab('login'); return false;">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="app" class="container" style="display: none;">
        <div class="header">
            <h1>RESET 2026</h1>
            <p class="subtitle">Nutrition & Fitness Challenge Tracker</p>
        </div>

        <div class="logged-in-user">
            <span id="userGreeting">Welcome!</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showSection('checkin')">Check In</button>
            <button class="nav-btn" onclick="showSection('leaderboard')">Leaderboard</button>
            <button class="nav-btn" onclick="showSection('teams')">Teams</button>
            <button class="nav-btn admin" id="adminNavBtn" onclick="showSection('admin')" style="display: none;">Admin</button>
        </div>

        <!-- Check In Section -->
        <div id="checkin" class="section active">
            <div class="card">
                <h2>Weekly Check-In</h2>
                
                <!-- Check-in window status banner -->
                <div id="checkinWindowBanner"></div>
                
                <div class="success-message" id="checkinSuccess"></div>
                <form id="checkinForm">
                    <h3 style="color: #7ed957; margin: 30px 0 15px 0;">üí™ Earn Points</h3>
                    
                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Hit Protein Goal</span>
                            <span class="challenge-points">+5 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_mon" class="protein-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_tue" class="protein-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_wed" class="protein-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_thu" class="protein-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_fri" class="protein-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_sat" class="protein-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="protein_sun" class="protein-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Hit Water Goal</span>
                            <span class="challenge-points">+5 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_mon" class="water-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_tue" class="water-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_wed" class="water-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_thu" class="water-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_fri" class="water-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_sat" class="water-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="water_sun" class="water-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Attended 3+ Classes This Week</span>
                            <span class="challenge-points">+15 pts</span>
                        </div>
                        <div class="single-checkbox">
                            <input type="checkbox" id="classes">
                            <label for="classes">Completed</label>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Stretching/Yoga/Recovery</span>
                            <span class="challenge-points">+3 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_mon" class="recovery-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_tue" class="recovery-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_wed" class="recovery-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_thu" class="recovery-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_fri" class="recovery-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_sat" class="recovery-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="recovery_sun" class="recovery-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Completed Weekly Challenge</span>
                            <span class="challenge-points">+20 pts</span>
                        </div>
                        <div class="single-checkbox">
                            <input type="checkbox" id="weekly">
                            <label for="weekly">Completed</label>
                        </div>
                    </div>

                    <h3 style="color: #ff6b6b; margin: 30px 0 15px 0;">‚ö†Ô∏è Deductions</h3>

                    <div class="challenge-item deduction-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Consumed Alcohol</span>
                            <span class="challenge-points deduction-points">-5 pts/day</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_mon" class="alcohol-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_tue" class="alcohol-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_wed" class="alcohol-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_thu" class="alcohol-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_fri" class="alcohol-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_sat" class="alcohol-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="alcohol_sun" class="alcohol-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item deduction-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Late to Class</span>
                            <span class="challenge-points deduction-points">-3 pts/occurrence</span>
                        </div>
                        <div class="days-grid">
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_mon" class="late-check">
                                <label>Mon</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_tue" class="late-check">
                                <label>Tue</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_wed" class="late-check">
                                <label>Wed</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_thu" class="late-check">
                                <label>Thu</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_fri" class="late-check">
                                <label>Fri</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_sat" class="late-check">
                                <label>Sat</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="late_sun" class="late-check">
                                <label>Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-item deduction-item">
                        <div class="challenge-header">
                            <span class="challenge-name">Missed Weekly Check-In</span>
                            <span class="challenge-points deduction-points">-10 pts</span>
                        </div>
                        <div class="single-checkbox deduction">
                            <input type="checkbox" id="missed">
                            <label for="missed">Yes, I missed last week</label>
                        </div>
                    </div>

                    <div class="total-score" id="totalScore">
                        Total Weekly Score: 0 points
                    </div>

                    <button type="submit" class="btn" id="checkinBtn">Submit Check-In</button>
                </form>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboard" class="section">
            <div class="card">
                <h2>üèÜ Leaderboard</h2>
                
                <!-- Team Standings -->
                <div id="teamStandings" style="margin-bottom: 30px;">
                    <h3 style="color: #4facfe; margin-bottom: 15px;">Team Standings</h3>
                    <div class="team-leaderboard" id="teamLeaderboard">
                        <!-- Team cards will be inserted here -->
                    </div>
                </div>

                <h3 style="color: #4facfe; margin-bottom: 15px;">Individual Rankings</h3>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Team</th>
                            <th>Total Points</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr><td colspan="4" style="text-align: center; padding: 30px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Teams Page -->
        <div id="teams" class="section">
            <div class="card">
                <h2>üë• Team Rosters</h2>
                <p style="color: #666; margin-bottom: 30px;">View all team members, captains, and individual scores</p>
                <div id="teamsContent">
                    <p style="text-align: center; padding: 30px;">Loading teams...</p>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="admin" class="section">
            <div class="card">
                <h2>üîß Admin Dashboard</h2>
                <div class="info-message">
                    <strong>Admin Access:</strong> You can export data and manage user visibility on the leaderboard.
                </div>

                <div class="admin-controls">
                    <div class="admin-card">
                        <h3>Total Users</h3>
                        <div class="stat" id="totalUsers">0</div>
                    </div>
                    <div class="admin-card">
                        <h3>Total Check-ins</h3>
                        <div class="stat" id="totalCheckins">0</div>
                    </div>
                    <div class="admin-card">
                        <h3>Visible Users</h3>
                        <div class="stat" id="visibleUsers">0</div>
                    </div>
                </div>

                <div class="window-control">
                    <h3 style="margin-bottom: 15px;">‚è∞ Check-In Window Control</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        Control when members can submit their weekly check-ins. When closed, members will see a message and cannot check in.
                    </p>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <span style="font-weight: 600;">Current Status:</span>
                        <span class="window-status" id="windowStatus">Loading...</span>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="window.toggleCheckinWindow(true)" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);">
                            ‚úÖ Open Check-Ins
                        </button>
                        <button class="btn btn-danger" onclick="window.toggleCheckinWindow(false)" style="flex: 1; min-width: 150px;">
                            üö´ Close Check-Ins
                        </button>
                    </div>
                    <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                        üí° Tip: Close check-ins on Sunday night and reopen them Monday morning for the new week!
                    </p>
                </div>

                <div class="export-section">
                    <h3>Export Data</h3>
                    <p style="margin-bottom: 15px; color: #666;">Download all user and check-in data as CSV files for analysis.</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportUsersCSV()" style="flex: 1; min-width: 200px;">
                            üìä Export All Users
                        </button>
                        <button class="btn btn-secondary" onclick="exportCheckinsCSV()" style="flex: 1; min-width: 200px;">
                            üìã Export All Check-ins
                        </button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Customize Team Names</h3>
                    <p style="margin-bottom: 15px; color: #666;">Give each team a custom name while keeping their colors!</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: #ff6b6b; padding: 15px; border-radius: 10px; color: white;">
                            <strong>üî¥ Red Team</strong>
                            <input type="text" class="team-name-input" id="teamName_red" placeholder="e.g., Red Warriors" 
                                   onblur="window.updateTeamName('red', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #4facfe; padding: 15px; border-radius: 10px; color: white;">
                            <strong>üîµ Blue Team</strong>
                            <input type="text" class="team-name-input" id="teamName_blue" placeholder="e.g., Blue Legends" 
                                   onblur="window.updateTeamName('blue', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #7ed957; padding: 15px; border-radius: 10px; color: white;">
                            <strong>üü¢ Green Team</strong>
                            <input type="text" class="team-name-input" id="teamName_green" placeholder="e.g., Green Machines" 
                                   onblur="window.updateTeamName('green', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #ffd93d; padding: 15px; border-radius: 10px; color: #333;">
                            <strong>üü° Yellow Team</strong>
                            <input type="text" class="team-name-input" id="teamName_yellow" placeholder="e.g., Yellow Thunder" 
                                   onblur="window.updateTeamName('yellow', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}" 
                                   style="color: #333; background: rgba(255,255,255,0.8);">
                        </div>
                        <div style="background: #a55eea; padding: 15px; border-radius: 10px; color: white;">
                            <strong>üü£ Purple Team</strong>
                            <input type="text" class="team-name-input" id="teamName_purple" placeholder="e.g., Purple Reign" 
                                   onblur="window.updateTeamName('purple', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #ff9f43; padding: 15px; border-radius: 10px; color: white;">
                            <strong>üü† Orange Team</strong>
                            <input type="text" class="team-name-input" id="teamName_orange" placeholder="e.g., Orange Crush" 
                                   onblur="window.updateTeamName('orange', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #fd79a8; padding: 15px; border-radius: 10px; color: white;">
                            <strong>ü©∑ Pink Team</strong>
                            <input type="text" class="team-name-input" id="teamName_pink" placeholder="e.g., Pink Panthers" 
                                   onblur="window.updateTeamName('pink', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                        <div style="background: #00d2d3; padding: 15px; border-radius: 10px; color: white;">
                            <strong>ü©µ Teal Team</strong>
                            <input type="text" class="team-name-input" id="teamName_teal" placeholder="e.g., Teal Titans" 
                                   onblur="window.updateTeamName('teal', this.value)"
                                   onkeypress="if(event.key==='Enter'){event.preventDefault();this.blur();}">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Manage User Teams & Visibility</h3>
                    <p style="margin-bottom: 15px; color: #666;">Assign users to colored teams and control leaderboard visibility.</p>
                    <div class="user-list" id="adminUserList">
                        <p style="text-align: center; padding: 20px;">Loading users...</p>
                    </div>
                </div>

                <div class="export-section" style="margin-top: 30px;">
                    <h3>Export by Team</h3>
                    <p style="margin-bottom: 15px; color: #666;">Download user and check-in data filtered by team.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button class="btn btn-secondary" onclick="exportTeamData('red')" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);">
                            üìä Red Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('blue')" style="background: linear-gradient(135deg, #4facfe 0%, #3d8fd1 100%);">
                            üìä Blue Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('green')" style="background: linear-gradient(135deg, #7ed957 0%, #5cb85c 100%);">
                            üìä Green Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('yellow')" style="background: linear-gradient(135deg, #ffd93d 0%, #f5c542 100%);">
                            üìä Yellow Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('purple')" style="background: linear-gradient(135deg, #a55eea 0%, #8854d0 100%);">
                            üìä Purple Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('orange')" style="background: linear-gradient(135deg, #ff9f43 0%, #ee8f34 100%);">
                            üìä Orange Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('pink')" style="background: linear-gradient(135deg, #fd79a8 0%, #e66992 100%);">
                            üìä Pink Team
                        </button>
                        <button class="btn btn-secondary" onclick="exportTeamData('teal')" style="background: linear-gradient(135deg, #00d2d3 0%, #00b4b5 100%);">
                            üìä Teal Team
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, where, getDocs, updateDoc, increment, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // REPLACE THESE WITH YOUR FIREBASE CONFIG
        const firebaseConfig = {
              apiKey: "AIzaSyDbvV8uX5OnPRJChm6Q58ca7lyvHg2jqRo",
  authDomain: "reset-2026-tracker.firebaseapp.com",
  projectId: "reset-2026-tracker",
  storageBucket: "reset-2026-tracker.firebasestorage.app",
  messagingSenderId: "867262535384",
  appId: "1:867262535384:web:a9d18d62159c657f4ca9ad"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ADMIN EMAIL - Change this to YOUR email address
        const ADMIN_EMAILS = [
            "seanswetz@pm.me", 
            "hayley.ciarrocchi@gmail.com",
            ];

        let currentUser = null;
        let isAdmin = false;

        // Hide loading screen
        document.getElementById('loading').style.display = 'none';

        // Check auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    isAdmin = user.email.toLowerCase() === ADMIN_EMAILS.toLowerCase();
                    showApp();
                }
            } else {
                showAuthPage();
            }
        });

        function showApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('userGreeting').textContent = `Welcome, ${currentUser.name}!${isAdmin ? ' (Admin)' : ''}`;
            
            if (isAdmin) {
                document.getElementById('adminNavBtn').style.display = 'block';
            }
            
            checkCheckinWindow();
            loadLeaderboard();
        }

        function showAuthPage() {
            document.getElementById('authPage').style.display = 'block';
            document.getElementById('app').style.display = 'none';
        }

        // Auth tab switching
        window.showAuthTab = function(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else if (tab === 'register') {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            } else if (tab === 'reset') {
                document.getElementById('resetForm').classList.add('active');
            }
            hideMessages();
        };

        function hideMessages() {
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showAuthSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 5000);
        }

        // Registration
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const btn = document.getElementById('registerBtn');

            btn.disabled = true;
            btn.textContent = 'Creating Account...';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    totalPoints: 0,
                    team: 'none',
                    isCaptain: false,
                    hiddenFromLeaderboard: false,
                    registeredAt: new Date().toISOString()
                });

                showAuthSuccess('Account created successfully!');
                document.getElementById('registerForm').reset();
                setTimeout(() => window.showAuthTab('login'), 2000);
            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showAuthError('This email is already registered. Please login instead.');
                } else if (error.code === 'auth/weak-password') {
                    showAuthError('Password should be at least 6 characters.');
                } else {
                    showAuthError('Registration failed. Please try again.');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.textContent = 'Logging in...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    showAuthError('Invalid email or password.');
                } else {
                    showAuthError('Login failed. Please try again.');
                }
                btn.disabled = false;
                btn.textContent = 'Login';
            }
        });

        // Password Reset
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const email = document.getElementById('resetEmail').value;
            const btn = document.getElementById('resetBtn');

            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                await sendPasswordResetEmail(auth, email);
                showAuthSuccess('Password reset email sent! Check your inbox.');
                document.getElementById('resetForm').reset();
                setTimeout(() => window.showAuthTab('login'), 3000);
            } catch (error) {
                console.error('Reset error:', error);
                if (error.code === 'auth/user-not-found') {
                    showAuthError('No account found with this email.');
                } else {
                    showAuthError('Failed to send reset email. Please try again.');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Reset Link';
            }
        });

        // Logout
        window.logout = async function() {
            try {
                await signOut(auth);
                currentUser = null;
                isAdmin = false;
                document.getElementById('loginForm').reset();
                document.getElementById('adminNavBtn').style.display = 'none';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // Navigation
        window.showSection = function(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            if (sectionName === 'leaderboard') {
                loadLeaderboard();
            } else if (sectionName === 'teams') {
                loadTeamsPage();
            } else if (sectionName === 'admin' && isAdmin) {
                loadAdminData();
            }
        };

        // Calculate total score
        function updateTotalScore() {
            const protein = document.querySelectorAll('.protein-check:checked').length;
            const water = document.querySelectorAll('.water-check:checked').length;
            const classes = document.getElementById('classes').checked ? 1 : 0;
            const recovery = document.querySelectorAll('.recovery-check:checked').length;
            const weekly = document.getElementById('weekly').checked ? 1 : 0;
            const alcohol = document.querySelectorAll('.alcohol-check:checked').length;
            const late = document.querySelectorAll('.late-check:checked').length;
            const missed = document.getElementById('missed').checked ? 1 : 0;

            const total = (protein * 5) + (water * 5) + (classes * 15) + 
                         (recovery * 3) + (weekly * 20) - (alcohol * 5) - 
                         (late * 3) - (missed * 10);

            document.getElementById('totalScore').textContent = 
                `Total Weekly Score: ${total} points`;
        }

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateTotalScore);
        });

        // Check-in Form
        document.getElementById('checkinForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) return;

            const btn = document.getElementById('checkinBtn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            const protein = document.querySelectorAll('.protein-check:checked').length;
            const water = document.querySelectorAll('.water-check:checked').length;
            const classes = document.getElementById('classes').checked ? 1 : 0;
            const recovery = document.querySelectorAll('.recovery-check:checked').length;
            const weekly = document.getElementById('weekly').checked ? 1 : 0;
            const alcohol = document.querySelectorAll('.alcohol-check:checked').length;
            const late = document.querySelectorAll('.late-check:checked').length;
            const missed = document.getElementById('missed').checked ? 1 : 0;

            const weeklyScore = (protein * 5) + (water * 5) + (classes * 15) + 
                               (recovery * 3) + (weekly * 20) - (alcohol * 5) - 
                               (late * 3) - (missed * 10);

            try {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    totalPoints: increment(weeklyScore),
                    lastCheckin: new Date().toISOString()
                });

                await addDoc(collection(db, 'checkins'), {
                    userId: currentUser.uid,
                    name: currentUser.name,
                    email: currentUser.email,
                    weeklyScore: weeklyScore,
                    details: { protein, water, classes, recovery, weekly, alcohol, late, missed },
                    timestamp: new Date().toISOString()
                });

                currentUser.totalPoints = (currentUser.totalPoints || 0) + weeklyScore;

                const successMsg = document.getElementById('checkinSuccess');
                successMsg.textContent = `Check-in submitted! You earned ${weeklyScore} points this week. Your total is now ${currentUser.totalPoints} points.`;
                successMsg.style.display = 'block';
                
                document.getElementById('checkinForm').reset();
                updateTotalScore();

                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 5000);

            } catch (error) {
                console.error('Check-in error:', error);
                alert('Failed to submit check-in. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit Check-In';
            }
        });

        // Load Leaderboard
        async function loadLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px;">Loading...</td></tr>';

            try {
                // Fetch all users (no complex query to avoid indexing issues)
                const q = query(collection(db, 'users'));
                const querySnapshot = await getDocs(q);
                
                const leaderboardData = [];
                const teamTotals = {
                    red: { points: 0, members: 0 },
                    blue: { points: 0, members: 0 },
                    green: { points: 0, members: 0 },
                    yellow: { points: 0, members: 0 },
                    purple: { points: 0, members: 0 },
                    orange: { points: 0, members: 0 },
                    pink: { points: 0, members: 0 },
                    teal: { points: 0, members: 0 }
                };

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    // Only include users who aren't hidden from leaderboard
                    if (!userData.hiddenFromLeaderboard) {
                        leaderboardData.push({ uid: doc.id, ...userData });
                        
                        // Calculate team totals
                        const team = userData.team || 'none';
                        if (teamTotals[team]) {
                            teamTotals[team].points += (userData.totalPoints || 0);
                            teamTotals[team].members += 1;
                        }
                    }
                });

                // Sort by points (client-side)
                leaderboardData.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));

                // Display team standings
                displayTeamStandings(teamTotals);

                tbody.innerHTML = '';
                if (leaderboardData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">No check-ins yet. Be the first!</td></tr>';
                    return;
                }

                leaderboardData.forEach((member, index) => {
                    const row = tbody.insertRow();
                    const rankClass = index < 3 ? `rank-${index + 1}` : '';
                    const isCurrentUser = currentUser && member.uid === currentUser.uid;
                    const teamBadge = member.team && member.team !== 'none' 
                        ? `<span class="team-badge team-${member.team}">${member.team.toUpperCase()}</span>`
                        : '';
                    
                    row.style.background = isCurrentUser ? '#e8f5e9' : '';
                    row.innerHTML = `
                        <td><span class="rank ${rankClass}">${index + 1}</span></td>
                        <td>${member.name}${isCurrentUser ? ' (You)' : ''}</td>
                        <td>${teamBadge || '<span style="color: #999;">No Team</span>'}</td>
                        <td><strong>${member.totalPoints || 0} pts</strong></td>
                    `;
                });

            } catch (error) {
                console.error('Leaderboard error:', error);
                console.error('Full error details:', error.message, error.code);
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 30px; color: #ff6b6b;">
                    Error loading leaderboard: ${error.message}<br><small>Check console for details</small>
                </td></tr>`;
            }
        }

        function displayTeamStandings(teamTotals) {
            const teamLeaderboard = document.getElementById('teamLeaderboard');
            
            // Convert to array and sort by points
            const teams = Object.entries(teamTotals)
                .map(([name, data]) => ({ name, ...data }))
                .filter(team => team.members > 0)
                .sort((a, b) => b.points - a.points);

            if (teams.length === 0) {
                teamLeaderboard.innerHTML = '<p style="text-align: center; color: #999;">No teams assigned yet</p>';
                return;
            }

            teamLeaderboard.innerHTML = teams.map(team => `
                <div class="team-card team-${team.name}">
                    <h3>${team.name.toUpperCase()} TEAM</h3>
                    <div class="team-stat">${team.points} pts</div>
                    <div class="team-members">${team.members} member${team.members !== 1 ? 's' : ''}</div>
                </div>
            `).join('');
        }

        window.loadLeaderboard = loadLeaderboard;

        // Check-in window control
        async function checkCheckinWindow() {
            try {
                const windowDoc = await getDoc(doc(db, 'settings', 'checkinWindow'));
                const isOpen = windowDoc.exists() ? windowDoc.data().isOpen !== false : true;
                
                const banner = document.getElementById('checkinWindowBanner');
                const form = document.getElementById('checkinForm');
                const submitBtn = document.getElementById('checkinBtn');
                
                if (!isOpen) {
                    banner.innerHTML = `
                        <div class="checkin-closed-banner">
                            <strong>üö´ Check-In Window is Currently Closed</strong>
                            Check back later or contact your gym administrator.
                        </div>
                    `;
                    form.style.opacity = '0.5';
                    form.style.pointerEvents = 'none';
                    submitBtn.disabled = true;
                } else {
                    banner.innerHTML = `
                        <div class="checkin-open-banner">
                            ‚úÖ Check-in window is open! Submit your weekly progress below.
                        </div>
                    `;
                    form.style.opacity = '1';
                    form.style.pointerEvents = 'auto';
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Check window error:', error);
            }
        }

        window.toggleCheckinWindow = async function(open) {
            if (!isAdmin) return;

            try {
                await setDoc(doc(db, 'settings', 'checkinWindow'), {
                    isOpen: open,
                    lastUpdated: new Date().toISOString()
                });
                loadAdminData();
                checkCheckinWindow();
                alert(open ? 'Check-in window opened!' : 'Check-in window closed!');
            } catch (error) {
                console.error('Toggle window error:', error);
                alert('Failed to update check-in window');
            }
        };

        // Admin Functions
        async function loadAdminData() {
            if (!isAdmin) return;

            try {
                // Get all users
                const usersQuery = query(collection(db, 'users'));
                const usersSnapshot = await getDocs(usersQuery);
                const totalUsers = usersSnapshot.size;
                const visibleUsers = usersSnapshot.docs.filter(doc => !doc.data().hiddenFromLeaderboard).length;

                // Get all check-ins
                const checkinsQuery = query(collection(db, 'checkins'));
                const checkinsSnapshot = await getDocs(checkinsQuery);
                const totalCheckins = checkinsSnapshot.size;

                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('totalCheckins').textContent = totalCheckins;
                document.getElementById('visibleUsers').textContent = visibleUsers;

                // Load check-in window status
                const windowDoc = await getDoc(doc(db, 'settings', 'checkinWindow'));
                const isOpen = windowDoc.exists() ? windowDoc.data().isOpen !== false : true;
                const statusEl = document.getElementById('windowStatus');
                statusEl.textContent = isOpen ? 'OPEN' : 'CLOSED';
                statusEl.className = 'window-status ' + (isOpen ? 'open' : 'closed');

                // Load team names
                const teamNamesDoc = await getDoc(doc(db, 'settings', 'teamNames'));
                if (teamNamesDoc.exists()) {
                    const teamNames = teamNamesDoc.data();
                    ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink', 'teal'].forEach(color => {
                        const input = document.getElementById(`teamName_${color}`);
                        if (input && teamNames[color]) {
                            input.value = teamNames[color];
                        }
                    });
                }

                // Load user list
                const userList = document.getElementById('adminUserList');
                userList.innerHTML = '';

                const users = [];
                usersSnapshot.forEach((doc) => {
                    users.push({ uid: doc.id, ...doc.data() });
                });

                users.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));

                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    
                    const teamBadge = user.team && user.team !== 'none' 
                        ? `<span class="team-badge team-${user.team}">${user.team.toUpperCase()}</span>`
                        : '<span style="color: #999; font-size: 0.9em;">No Team</span>';
                    
                    const captainBadge = user.isCaptain 
                        ? '<span class="captain-badge">‚≠ê CAPTAIN</span>'
                        : '';
                    
                    userItem.innerHTML = `
                        <div class="user-info">
                            <strong>${user.name}</strong> ${teamBadge} ${captainBadge}<br>
                            <small>${user.email} ‚Ä¢ ${user.totalPoints || 0} points</small>
                        </div>
                        <div class="user-actions">
                            <select class="team-select" onchange="window.assignTeam('${user.uid}', this.value)">
                                <option value="none" ${(!user.team || user.team === 'none') ? 'selected' : ''}>No Team</option>
                                <option value="red" ${user.team === 'red' ? 'selected' : ''}>üî¥ Red</option>
                                <option value="blue" ${user.team === 'blue' ? 'selected' : ''}>üîµ Blue</option>
                                <option value="green" ${user.team === 'green' ? 'selected' : ''}>üü¢ Green</option>
                                <option value="yellow" ${user.team === 'yellow' ? 'selected' : ''}>üü° Yellow</option>
                                <option value="purple" ${user.team === 'purple' ? 'selected' : ''}>üü£ Purple</option>
                                <option value="orange" ${user.team === 'orange' ? 'selected' : ''}>üü† Orange</option>
                                <option value="pink" ${user.team === 'pink' ? 'selected' : ''}>ü©∑ Pink</option>
                                <option value="teal" ${user.team === 'teal' ? 'selected' : ''}>ü©µ Teal</option>
                            </select>
                            <button class="small-btn ${user.isCaptain ? 'btn-show' : 'btn-secondary'}" 
                                    onclick="window.toggleCaptain('${user.uid}', ${!user.isCaptain})"
                                    style="${user.isCaptain ? 'background: gold; color: #333;' : ''}">
                                ${user.isCaptain ? '‚≠ê Captain' : 'Make Captain'}
                            </button>
                            ${user.hiddenFromLeaderboard 
                                ? `<button class="small-btn btn-show" onclick="window.toggleUserVisibility('${user.uid}', false)">Show</button>`
                                : `<button class="small-btn btn-hide" onclick="window.toggleUserVisibility('${user.uid}', true)">Hide</button>`
                            }
                        </div>
                    `;
                    userList.appendChild(userItem);
                });

            } catch (error) {
                console.error('Admin data error:', error);
            }
        }

        window.toggleUserVisibility = async function(userId, hide) {
            if (!isAdmin) return;

            try {
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    hiddenFromLeaderboard: hide
                });
                loadAdminData();
                loadLeaderboard();
            } catch (error) {
                console.error('Toggle visibility error:', error);
                alert('Failed to update user visibility');
            }
        };

        window.assignTeam = async function(userId, team) {
            if (!isAdmin) return;

            try {
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    team: team
                });
                loadAdminData();
                loadLeaderboard();
            } catch (error) {
                console.error('Assign team error:', error);
                alert('Failed to assign team');
            }
        };

        window.toggleCaptain = async function(userId, makeCaptain) {
            if (!isAdmin) return;

            try {
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    isCaptain: makeCaptain
                });
                loadAdminData();
                loadTeamsPage();
            } catch (error) {
                console.error('Toggle captain error:', error);
                alert('Failed to update captain status');
            }
        };

        window.updateTeamName = async function(color, name) {
            if (!isAdmin) return;

            try {
                const teamNamesRef = doc(db, 'settings', 'teamNames');
                const teamNamesDoc = await getDoc(teamNamesRef);
                
                const currentNames = teamNamesDoc.exists() ? teamNamesDoc.data() : {};
                currentNames[color] = name || null;

                await setDoc(teamNamesRef, currentNames);
                loadTeamsPage();
            } catch (error) {
                console.error('Update team name error:', error);
                alert('Failed to update team name');
            }
        };

        // Load Teams Page
        async function loadTeamsPage() {
            const teamsContent = document.getElementById('teamsContent');
            teamsContent.innerHTML = '<p style="text-align: center; padding: 30px;">Loading teams...</p>';

            try {
                const q = query(collection(db, 'users'));
                const querySnapshot = await getDocs(q);
                
                // Get custom team names
                const teamNamesDoc = await getDoc(doc(db, 'settings', 'teamNames'));
                const teamNames = teamNamesDoc.exists() ? teamNamesDoc.data() : {};
                
                const teamGroups = {
                    red: [], blue: [], green: [], yellow: [],
                    purple: [], orange: [], pink: [], teal: [], none: []
                };

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (!userData.hiddenFromLeaderboard) {
                        const team = userData.team || 'none';
                        teamGroups[team].push({ uid: doc.id, ...userData });
                    }
                });

                // Sort each team by points
                Object.keys(teamGroups).forEach(team => {
                    teamGroups[team].sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
                });

                let html = '';

                // Show teams with members (sorted by total points)
                const teamColors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink', 'teal'];
                const teamsWithMembers = teamColors
                    .map(color => ({
                        color,
                        name: teamNames[color] || `${color.toUpperCase()} TEAM`,
                        members: teamGroups[color],
                        totalPoints: teamGroups[color].reduce((sum, m) => sum + (m.totalPoints || 0), 0)
                    }))
                    .filter(t => t.members.length > 0)
                    .sort((a, b) => b.totalPoints - a.totalPoints);

                teamsWithMembers.forEach(({ color, name, members, totalPoints }) => {
                    const captain = members.find(m => m.isCaptain);
                    
                    html += `
                        <div class="team-detail-section">
                            <div class="team-header team-${color} collapsed" onclick="toggleTeamAccordion(this)">
                                <div>
                                    <span class="team-color-label">üé® ${color}</span>
                                    <h3>${name}</h3>
                                    ${captain ? `<div style="font-size: 0.9em; margin-top: 5px;">‚≠ê Captain: ${captain.name}</div>` : ''}
                                </div>
                                <div class="team-total">
                                    <div class="label">${members.length} member${members.length !== 1 ? 's' : ''}</div>
                                    <div class="points">${totalPoints} pts</div>
                                </div>
                            </div>
                            <div class="team-members-container">
                                <div class="team-members-grid">
                                    ${members.map(member => {
                                        const isCurrentUser = currentUser && member.uid === currentUser.uid;
                                        return `
                                            <div class="member-card ${isCurrentUser ? 'current-user' : ''}" style="border-left-color: var(--team-${color});">
                                                <div class="member-name">
                                                    ${member.name}
                                                    ${member.isCaptain ? '<span class="captain-badge">‚≠ê CAPTAIN</span>' : ''}
                                                    ${isCurrentUser ? ' <span style="color: #7ed957;">(You)</span>' : ''}
                                                </div>
                                                <div class="member-points">${member.totalPoints || 0} pts</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Show unassigned members if any
                if (teamGroups.none.length > 0) {
                    html += `
                        <div class="no-team-section">
                            <h3 style="color: #856404; margin-bottom: 15px;">‚ö†Ô∏è Unassigned Members (${teamGroups.none.length})</h3>
                            <div class="team-members-grid">
                                ${teamGroups.none.map(member => {
                                    const isCurrentUser = currentUser && member.uid === currentUser.uid;
                                    return `
                                        <div class="member-card ${isCurrentUser ? 'current-user' : ''}" style="border-left-color: #ffc107;">
                                            <div class="member-name">
                                                ${member.name}
                                                ${isCurrentUser ? ' <span style="color: #7ed957;">(You)</span>' : ''}
                                            </div>
                                            <div class="member-points">${member.totalPoints || 0} pts</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                if (teamsWithMembers.length === 0 && teamGroups.none.length === 0) {
                    html = '<p style="text-align: center; padding: 50px; color: #999;">No teams or members yet!</p>';
                }

                teamsContent.innerHTML = html;

                // Add CSS variables for team colors
                const style = document.createElement('style');
                style.textContent = `
                    :root {
                        --team-red: #ff6b6b;
                        --team-blue: #4facfe;
                        --team-green: #7ed957;
                        --team-yellow: #ffd93d;
                        --team-purple: #a55eea;
                        --team-orange: #ff9f43;
                        --team-pink: #fd79a8;
                        --team-teal: #00d2d3;
                    }
                `;
                if (!document.getElementById('team-colors')) {
                    style.id = 'team-colors';
                    document.head.appendChild(style);
                }

            } catch (error) {
                console.error('Load teams error:', error);
                teamsContent.innerHTML = '<p style="text-align: center; padding: 30px; color: #ff6b6b;">Error loading teams</p>';
            }
        }

        // Toggle team accordion
        window.toggleTeamAccordion = function(header) {
            header.classList.toggle('collapsed');
            const container = header.nextElementSibling;
            container.classList.toggle('expanded');
        };

        window.exportTeamData = async function(teamColor) {
            if (!isAdmin) return;

            try {
                const usersQuery = query(collection(db, 'users'));
                const usersSnapshot = await getDocs(usersQuery);

                let csv = 'Name,Email,Team,Total Points,Hidden from Leaderboard,Registered At,Last Check-in\n';

                usersSnapshot.forEach((doc) => {
                    const user = doc.data();
                    if (user.team === teamColor) {
                        csv += `"${user.name}","${user.email}","${user.team || 'none'}",${user.totalPoints || 0},${user.hiddenFromLeaderboard ? 'Yes' : 'No'},"${user.registeredAt || ''}","${user.lastCheckin || ''}"\n`;
                    }
                });

                if (csv.split('\n').length <= 2) {
                    alert(`No members found on ${teamColor} team`);
                    return;
                }

                downloadCSV(csv, `reset-2026-${teamColor}-team.csv`);
            } catch (error) {
                console.error('Export team error:', error);
                alert('Failed to export team data');
            }
        };

        window.exportUsersCSV = async function() {
            if (!isAdmin) return;

            try {
                const usersQuery = query(collection(db, 'users'), orderBy('totalPoints', 'desc'));
                const usersSnapshot = await getDocs(usersQuery);

                let csv = 'Name,Email,Team,Total Points,Hidden from Leaderboard,Registered At,Last Check-in\n';

                usersSnapshot.forEach((doc) => {
                    const user = doc.data();
                    csv += `"${user.name}","${user.email}","${user.team || 'none'}",${user.totalPoints || 0},${user.hiddenFromLeaderboard ? 'Yes' : 'No'},"${user.registeredAt || ''}","${user.lastCheckin || ''}"\n`;
                });

                downloadCSV(csv, 'reset-2026-users.csv');
            } catch (error) {
                console.error('Export users error:', error);
                alert('Failed to export users');
            }
        };

        window.exportCheckinsCSV = async function() {
            if (!isAdmin) return;

            try {
                const checkinsQuery = query(collection(db, 'checkins'), orderBy('timestamp', 'desc'));
                const checkinsSnapshot = await getDocs(checkinsQuery);

                let csv = 'Name,Email,Weekly Score,Protein Days,Water Days,Classes,Recovery Days,Weekly Challenge,Alcohol Days,Late Days,Missed Check-in,Timestamp\n';

                checkinsSnapshot.forEach((doc) => {
                    const checkin = doc.data();
                    const d = checkin.details || {};
                    csv += `"${checkin.name}","${checkin.email}",${checkin.weeklyScore},${d.protein || 0},${d.water || 0},${d.classes || 0},${d.recovery || 0},${d.weekly || 0},${d.alcohol || 0},${d.late || 0},${d.missed || 0},"${checkin.timestamp}"\n`;
                });

                downloadCSV(csv, 'reset-2026-checkins.csv');
            } catch (error) {
                console.error('Export check-ins error:', error);
                alert('Failed to export check-ins');
            }
        };

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Initialize
        updateTotalScore();
    </script>
</body>
</html>
